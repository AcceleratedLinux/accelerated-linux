From 1ce235471d62af52fa83cb24257c62b2d2c55866 Mon Sep 17 00:00:00 2001
From: Robert Hodaszi <robert.hodaszi@digi.com>
Date: Thu, 17 Feb 2022 16:01:09 +0100
Subject: [PATCH] Add an option to disable the dbm module

---
 Makefile.pre.in |  5 ++++-
 configure.ac    | 11 +++++++++++
 2 files changed, 15 insertions(+), 1 deletion(-)

diff --git a/Makefile.pre.in b/Makefile.pre.in
index ba0ef57..b6dc18b 100644
--- a/Makefile.pre.in
+++ b/Makefile.pre.in
@@ -1434,7 +1434,6 @@ LIBSUBDIRS=	asyncio \
 		concurrent concurrent/futures \
 		csv \
 		ctypes ctypes/macholib \
-		dbm \
 		distutils distutils/command \
 		email email/mime \
 		encodings \
@@ -1549,6 +1548,10 @@ TESTSUBDIRS += \
 	lib2to3/tests/data/fixers/myfixes
 endif
 
+ifeq (@DBM@,yes)
+LIBSUBDIRS += dbm
+endif
+
 TEST_MODULES=@TEST_MODULES@
 libinstall:	build_all $(srcdir)/Modules/xxmodule.c
 	@for i in $(SCRIPTDIR) $(LIBDEST); \
diff --git a/configure.ac b/configure.ac
index 772d3c9..d870089 100644
--- a/configure.ac
+++ b/configure.ac
@@ -3515,6 +3515,17 @@ AC_ARG_ENABLE(idle3,
 	[ IDLE="${enableval}" ], [ IDLE=yes ])
 AC_MSG_RESULT($IDLE)
 
+AC_SUBST(DBM)
+AC_MSG_CHECKING(for --disable-dbm)
+AC_ARG_ENABLE(dbm,
+	AS_HELP_STRING([--disable-dbm], [disable dbm]),
+	[ DBM="${enableval}" ], [ DBM=yes ])
+AC_MSG_RESULT($DBM)
+if test "$DBM" = "no" ; then
+   DISABLED_EXTENSIONS="${DISABLED_EXTENSIONS} _gdbm"
+fi
+AC_MSG_RESULT($DISABLED_EXTENSIONS)
+
 # Check for enable-ipv6
 AH_TEMPLATE(ENABLE_IPV6, [Define if --enable-ipv6 is specified])
 AC_MSG_CHECKING([if --enable-ipv6 is specified])
-- 
2.27.0

