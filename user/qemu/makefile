QEMU_VERSION = 3.0.0
URL = https://wiki.qemu-project.org/download/qemu-$(QEMU_VERSION).tar.bz2

QEMU_TARGETS_$(CONFIG_USER_QEMU_AARCH64_SOFTMMU) += aarch64-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_AARCH64_LINUX_USER) += aarch64-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_ALPHA_SOFTMMU) += alpha-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_ALPHA_LINUX_USER) += alpha-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_ARM_SOFTMMU) += arm-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_ARM_LINUX_USER) += arm-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_ARMEB_LINUX_USER) += armeb-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_CRIS_SOFTMMU) += cris-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_CRIS_LINUX_USER) += cris-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_I386_SOFTMMU) += i386-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_I386_LINUX_USER) += i386-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_LM32_SOFTMMU) += lm32-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_M68K_SOFTMMU) += m68k-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_M68K_LINUX_USER) += m68k-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_MICROBLAZE_SOFTMMU) += microblaze-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_MICROBLAZE_LINUX_USER) += microblaze-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_MICROBLAZEEL_SOFTMMU) += microblazeel-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_MICROBLAZEEL_LINUX_USER) += microblazeel-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_MIPS_SOFTMMU) += mips-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_MIPS_LINUX_USER) += mips-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_MIPSEL_SOFTMMU) += mipsel-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_MIPSEL_LINUX_USER) += mipsel-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_MIPSN32_LINUX_USER) += mipsn32-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_MIPSN32EL_LINUX_USER) += mipsn32el-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_MIPS64_SOFTMMU) += mips64-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_MIPS64_LINUX_USER) += mips64-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_MIPS64EL_SOFTMMU) += mips64el-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_MIPS64EL_LINUX_USER) += mips64el-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_MOXIE_SOFTMMU) += moxie-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_OR32_SOFTMMU) += or32-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_OR32_LINUX_USER) += or32-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_PPC_SOFTMMU) += ppc-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_PPC_LINUX_USER) += ppc-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_PPCEMB_SOFTMMU) += ppcemb-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_PPC64_SOFTMMU) += ppc64-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_PPC64_LINUX_USER) += ppc64-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_PPC64ABI32_LINUX_USER) += ppc64abi32-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_PPC64LE_LINUX_USER) += ppc64le-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_S390X_SOFTMMU) += s390x-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_S390X_LINUX_USER) += s390x-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_SH4_SOFTMMU) += sh4-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_SH4_LINUX_USER) += sh4-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_SH4EB_SOFTMMU) += sh4eb-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_SH4EB_LINUX_USER) += sh4eb-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_SPARC_SOFTMMU) += sparc-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_SPARC_LINUX_USER) += sparc-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_SPARC32PLUS_LINUX_USER) += sparc32plus-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_SPARC64_SOFTMMU) += sparc64-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_SPARC64_LINUX_USER) += sparc64-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_TRICORE_SOFTMMU) += tricore-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_UNICORE32_SOFTMMU) += unicore32-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_UNICORE32_LINUX_USER) += unicore32-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_X86_64_SOFTMMU) += x86_64-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_X86_64_LINUX_USER) += x86_64-linux-user
QEMU_TARGETS_$(CONFIG_USER_QEMU_XTENSA_SOFTMMU) += xtensa-softmmu
QEMU_TARGETS_$(CONFIG_USER_QEMU_XTENSAEB_SOFTMMU) += xtensaeb-softmmu

#CONFVARS = env -i
qemu-$(QEMU_VERSION)_NODEFCONF = 1

qemu-$(QEMU_VERSION)_CONFOPTS = \
	--prefix=/usr \
	--cc="$(CC)" \
	--cxx="disable" \
	--host="$(MACHINE)" \
	--target-list="$(QEMU_TARGETS_y)" \
	--disable-gcrypt \
	--enable-kvm

CFLAGS := $(CFLAGS:-O1=)

qemu-$(QEMU_VERSION)_ROMFS = qemu_romfs

include $(ROOTDIR)/tools/automake.inc

qemu_romfs:
	# Create "kvm" executable if we have that for our target machine
	MACHINECAP=`echo $(MACHINE) | tr 'a-z' 'A-Z'` ; \
	CFGOPT="CONFIG_USER_QEMU_$${MACHINECAP}_SOFTMMU" ; \
	eval CFGSTATE=\"\$$$$CFGOPT\" ; \
	if [ "$$CFGSTATE" = "y" ] ; then \
		echo "#! /bin/sh\nexec qemu-system-$(MACHINE) -enable-kvm \"\$$@\"" > $(ROMFSDIR)/usr/bin/kvm ; \
		chmod 555 $(ROMFSDIR)/usr/bin/kvm ; \
	fi

