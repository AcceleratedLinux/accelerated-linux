
uClinux-dist-20120401's prerelease of 2.2.1

--- libosip2-2.2.0/ChangeLog
+++ libosip2-2.2.1-alpha/ChangeLog
@@ -1,3 +1,10 @@
+libosip2 (2.2.1)
+	* fix osip_body_clone method (add terminating NULL)
+	* fix for binary support when multipart is used.
+	* automatic check for reliable protocol SCTP and TLS.
+	* avoid <winsock.h> inclusion so user can (and must) now include either
+	  <winsock.h> or <winsock2.h> before including <osip/osip2.h>
+
 libosip2 (2.2.0)
 	* remove #ifdef OSIP_RETRANSMIT_2XX to always compile it.
 	* initialize remote_contact_uri when dialog is built with notify.
--- libosip2-2.2.0/configure.in
+++ libosip2-2.2.1-alpha/configure.in
@@ -1,5 +1,5 @@
 dnl Process this file with autoconf to produce a configure script.
-AC_REVISION($Revision: 1.63 $)dnl
+AC_REVISION($Revision: 1.65 $)dnl
 AC_PREREQ(2.50)
 AC_INIT(include/osip2/osip.h)
 
@@ -11,7 +11,7 @@
 dnl Source packaging numbers
 OSIP_MAJOR_VERSION=2
 OSIP_MINOR_VERSION=2
-OSIP_MICRO_VERSION=0
+OSIP_MICRO_VERSION=1
 
 SONAME_MAJOR_VERSION=3
 SONAME_MINOR_VERSION=0
@@ -25,7 +25,12 @@
 
 AC_SUBST(OSIP_VERSION)
 
-VERSION=$OSIP_VERSION
+if test "x$PRERELEASE" = "x"; then
+ VERSION=$OSIP_VERSION
+else
+ VERSION="$OSIP_VERSION-$PRERELEASE"
+fi
+
 PACKAGE=libosip2
 
 AC_MSG_RESULT([Configuring ${PACKAGE} ${VERSION}])
--- libosip2-2.2.0/debian/manpage.sgml.ex
+++ libosip2-2.2.1-alpha/debian/manpage.sgml.ex
@@ -57,7 +57,7 @@
     <para>This manual page documents briefly the
       <command>&dhpackage;</command> library.</para>
 
-    <para>API reference & FAQ can be found at http://www.fsf.org/software/osip/</para>
+    <para>API reference & FAQ can be found at http://www.gnu.org/software/osip/</para>
 
 <!--    <para><command>&dhpackage;</command> is a program that...</para>
 -->
--- libosip2-2.2.0/help/doxygen/ht0-initialize.dox
+++ libosip2-2.2.1-alpha/help/doxygen/ht0-initialize.dox
@@ -17,6 +17,19 @@
 	  return -1;
 </PRE>
 
+On windows, you should write
+
+<PRE>
+	#include <winsock2.h>
+	#include <osip2/osip.h>
+
+	int i;
+	osip_t *osip;
+	i=osip_init(&osip);
+	if (i!=0)
+	  return -1;
+</PRE>
+
 In case you want to use the state machines (transaction management),
 the second step will be to set a few callbacks which will inform
 you of any change in the state of a SIP transaction.
--- libosip2-2.2.0/help/man/osip.1
+++ libosip2-2.2.1-alpha/help/man/osip.1
@@ -48,7 +48,7 @@
 .SH "API and Reference Documentation" 
 .PP 
 API reference & Doxygen documentation is available for 
-osip at http://www.fsf.org/software/osip/ 
+osip at http://www.gnu.org/software/osip/ 
 .SH "osip general overview." 
 .PP 
 The file help/man/osip.html in the source distribution 
@@ -63,4 +63,4 @@
 .SH "AUTHOR" 
 .PP 
 This manual page was written by Aymeric Moizard jack at atosc.org. 
-.\" created by instant / docbook-to-man, Mon 31 Jan 2005, 13:16 
+.\" created by instant / docbook-to-man, Tue 22 Feb 2005, 00:25 
--- libosip2-2.2.0/help/man/osip.sgml
+++ libosip2-2.2.1-alpha/help/man/osip.sgml
@@ -112,7 +112,7 @@
     <title>API and Reference Documentation</title>
 
     <para>API reference & Doxygen documentation is available for
-       osip at http://www.fsf.org/software/osip/</para>
+       osip at http://www.gnu.org/software/osip/</para>
 
   </refsect1>
   <refsect1>
--- libosip2-2.2.0/include/osip2/internal.h
+++ libosip2-2.2.1-alpha/include/osip2/internal.h
@@ -30,6 +30,14 @@
 
 #ifndef DOXYGEN
 
+#if defined(WIN32) || defined(_WIN32_WCE)
+/* Struct timeval */
+struct timeval {
+        long    tv_sec;         /* seconds */
+        long    tv_usec;        /* and microseconds */
+};
+#endif
+
 /**
  * Structure for payload management. Each payload element
  * represents one codec of a media line.
@@ -69,42 +77,48 @@
 
 /* Thread abstraction layer definition */
 
-#ifdef __VXWORKS_OS__
-#include <taskLib.h>
-#endif
-
-#if defined(WIN32) || defined(_WIN32_WCE)
-
-#include <windows.h>
-#endif
-
-#if !defined(WIN32) && !defined(_WIN32_WCE) && defined(__PSOS__)
-#include <psos.h>
+/* Is there any thread implementation available? */
+/* HAVE_PTHREAD_H is not used any more! I keep it for a while... */
+#if !defined(__VXWORKS_OS__) && !defined(__PSOS__) && \
+	!defined(WIN32) && !defined(_WIN32_WCE) && !defined(HAVE_PTHREAD_WIN32) && \
+    !defined(HAVE_PTHREAD) && !defined(HAVE_PTHREAD_H) && !defined(HAVE_PTH_PTHREAD_H)
+#error No thread implementation found!
 #endif
 
-/* HAVE_PTHREAD_H is not used any more! I keep it for a while... */
-#if defined(HAVE_PTHREAD) || defined(HAVE_PTHREAD_H) || defined(HAVE_PTH_PTHREAD_H)
+/* Pthreads support: */
+/* - Unix: native Pthreads. */
+/* - Win32: Pthreads for Win32 (http://sources.redhat.com/pthreads-win32). */
+#if defined(HAVE_PTHREAD) || defined(HAVE_PTHREAD_H) || defined(HAVE_PTH_PTHREAD_H) || \
+	defined(HAVE_PTHREAD_WIN32)
 #include <pthread.h>
-typedef pthread_mutex_t osip_mutex_t;
+typedef pthread_t osip_thread_t;
 #endif
 
-#ifdef __VXWORKS_OS__
+/* Windows without Pthreads for Win32 */
+#if (defined(WIN32) || defined(_WIN32_WCE)) && !defined(HAVE_PTHREAD_WIN32)
+/* Prevent the inclusion of winsock.h */
+#define _WINSOCKAPI_
+#include <windows.h>
+#undef _WINSOCKAPI_
 typedef struct
 {
-  int id;
+  HANDLE h;
+  unsigned id;
 }
 osip_thread_t;
 #endif
 
-#if defined(WIN32) || defined(_WIN32_WCE)
+#ifdef __VXWORKS_OS__
+#include <taskLib.h>
 typedef struct
 {
-  HANDLE h;
-  unsigned id;
+  int id;
 }
 osip_thread_t;
+#endif
 
-#elif defined(__PSOS__)
+#ifdef __PSOS__
+#include <psos.h>
 typedef struct
 {
   unsigned long tid;
@@ -112,51 +126,20 @@
 osip_thread_t;
 #endif
 
-#if !defined(WIN32) && !defined(_WIN32_WCE) && !defined(__VXWORKS_OS__) && !defined(__POS__)
-#if defined(HAVE_PTHREAD) || defined(HAVE_PTHREAD_H) || defined(HAVE_PTH_PTHREAD_H)
-typedef pthread_t osip_thread_t;
-#else
-#error no thread implementation found!
-#endif
-#endif
-
 
 /* Semaphore and Mutex abstraction layer definition */
 
-#if defined(WIN32) || defined(_WIN32_WCE)
-#include <windows.h>
-typedef struct
-{
-  HANDLE h;
-}
-osip_mutex_t;
-typedef struct
-{
-  HANDLE h;
-}
-osip_sem_t;
-#endif
-
-#if (!(defined(WIN32) || defined (_WIN32_WCE)) && defined(__PSOS__))
-#include <Types.h>
-#include <os.h>
-typedef struct
-{
-  UInt32 id;
-}
-osip_mutex_t;
-typedef struct
-{
-  UInt32 id;
-}
-osip_sem_t;
+/* Is there any semaphore implementation available? */
+#if !defined(HAVE_SEMAPHORE_H) && !defined(HAVE_SYS_SEM_H) && \
+    !defined(WIN32) && !defined(_WIN32_WCE) && !defined(HAVE_PTHREAD_WIN32) && \
+    !defined(__PSOS__) && !defined(__VXWORKS_OS__)
+#error No semaphore implementation found
 #endif
 
-#ifdef __VXWORKS_OS__
-#include <semaphore.h>
-#include <semLib.h>
-typedef struct semaphore osip_mutex_t;
-typedef sem_t osip_sem_t;
+/* Pthreads */
+#if defined(HAVE_PTHREAD) || defined(HAVE_PTHREAD_H) || defined(HAVE_PTH_PTHREAD_H) || \
+	defined(HAVE_PTHREAD_WIN32)
+typedef pthread_mutex_t osip_mutex_t;
 #endif
 
 #ifdef __sun__
@@ -165,8 +148,7 @@
 #include <synch.h>
 #endif
 
-
-#if defined(HAVE_SEMAPHORE_H) && !defined(__APPLE_CC__)
+#if (defined(HAVE_SEMAPHORE_H) && !defined(__APPLE_CC__)) || defined(HAVE_PTHREAD_WIN32)
 #include <semaphore.h>
 #ifdef __sun__
 #undef getdate
@@ -189,33 +171,61 @@
 osip_sem_t;
 #endif
 
-#if (!defined(HAVE_SEMAPHORE_H) && !defined(HAVE_SYS_SEM_H) && !defined(WIN32) && !defined(_WIN32_WCE) && !defined(__PSOS__) && !defined(__VXWORKS_OS__))
-#error No semaphore implementation found
+/* Windows without Pthreads for Win32 */
+#if (defined(WIN32) || defined(_WIN32_WCE)) && !defined(HAVE_PTHREAD_WIN32)
+/* Prevent the inclusion of winsock.h */
+#define _WINSOCKAPI_
+#include <windows.h>
+#undef _WINSOCKAPI_
+typedef struct
+{
+  HANDLE h;
+}
+osip_mutex_t;
+typedef struct
+{
+  HANDLE h;
+}
+osip_sem_t;
 #endif
 
-#if defined(__PSOS__) || defined(__VXWORKS_OS__)
+#ifdef __VXWORKS_OS__
+#include <semaphore.h>
+#include <semLib.h>
+typedef struct semaphore osip_mutex_t;
+typedef sem_t osip_sem_t;
+#endif
 
-typedef struct osip_cond
+#ifdef __PSOS__
+#include <Types.h>
+#include <os.h>
+typedef struct
 {
-  struct osip_sem *sem;
-} osip_cond_t;
+  UInt32 id;
+}
+osip_mutex_t;
+typedef struct
+{
+  UInt32 id;
+}
+osip_sem_t;
+#endif
 
 
-#else
+/* Condition variable abstraction layer definition */
 
 /**
  * Structure for referencing a condition variable element.
  * @var osip_cond_t
  */
-#if defined(HAVE_PTHREAD) || defined(HAVE_PTH_PTHREAD_H)
+#if defined(HAVE_PTHREAD) || defined(HAVE_PTH_PTHREAD_H) || defined(HAVE_PTHREAD_WIN32)
 typedef struct osip_cond
 {
   pthread_cond_t cv;
 } osip_cond_t;
-
 #endif
 
-#ifdef WIN32
+#if (defined(WIN32) || defined(_WIN32_WCE)) && !defined(HAVE_PTHREAD_WIN32)
 typedef struct osip_cond
 {
   struct osip_mutex *mut;
@@ -223,10 +233,15 @@
 } osip_cond_t;
 #endif
 
+#if defined(__PSOS__) || defined(__VXWORKS_OS__)
+typedef struct osip_cond
+{
+  struct osip_sem *sem;
+} osip_cond_t;
 #endif
 
-#endif
+#endif /* #ifdef OSIP_MT */
 
-#endif
+#endif /* #ifndef DOXYGEN */
 
-#endif
+#endif /* #ifndef _INTERNAL_H_ */
--- libosip2-2.2.0/include/osip2/Makefile.am
+++ libosip2-2.2.1-alpha/include/osip2/Makefile.am
@@ -5,5 +5,6 @@
 
 osip2_include_HEADERS= \
 osip.h     osip_dialog.h osip_negotiation.h \
-osip_mt.h  osip_fifo.h   osip_condv.h
+osip_mt.h  osip_fifo.h   osip_condv.h       \
+osip_time.h
 
--- libosip2-2.2.0/include/osip2/osip_condv.h
+++ libosip2-2.2.1-alpha/include/osip2/osip_condv.h
@@ -56,15 +56,19 @@
 
 /* condv implementation */
 #if defined(WIN32) || defined(_WIN32_WCE)
+/* Prevent struct redefinition if Pthreads for Win32 is used */
+#ifndef HAVE_STRUCT_TIMESPEC
+#define HAVE_STRUCT_TIMESPEC 1
 /**
  * timespec structure
  * @struct timespec
  */
-  struct timespec
-  {
-    long tv_sec;
-    long tv_nsec;
-  };
+struct timespec
+{
+  long tv_sec;
+  long tv_nsec;
+};
+#endif
 #endif
 
   struct osip_cond;
--- libosip2-2.2.0/include/osip2/osip_dialog.h
+++ libosip2-2.2.1-alpha/include/osip2/osip_dialog.h
@@ -190,7 +190,7 @@
 					   osip_message_t * response);
 
 /**
- * Match a request (response sent??) received with a dialog.
+ * Match a request (response sent?) received with a dialog.
  * @param dialog The element to work on.
  * @param request The request received.
  */
--- libosip2-2.2.0/include/osip2/osip.h
+++ libosip2-2.2.1-alpha/include/osip2/osip.h
@@ -23,11 +23,8 @@
 
 #include <osipparser2/osip_const.h>
 
-#include <time.h>
-
-#ifdef WIN32
-#include <Winsock.h>
-#endif
+/* Time-related functions and data types */
+#include <osip2/osip_time.h>
 
 #ifdef __sun
 #include <sys/types.h>
@@ -652,7 +649,6 @@
   int osip_transaction_get_destination (osip_transaction_t * transaction,
 					char **ip, int *port);
 
-#ifndef DOXYGEN
 
 /**
  * Set the socket for incoming message.
@@ -672,24 +668,6 @@
 				       int sock);
 
 
-#if 0
-
-
-/**
- * Check if the first 2 parameters match the other ones.
- * NOTE: THIS IS AN INTERNAL METHOD ONLY
- * @param to1 The initial to header.
- * @param from1 The initial from header.
- * @param to2 The new to header.
- * @param from2 The new from header.
- */
-  int callleg_match (osip_to_t * to1, osip_from_t * from1, osip_to_t * to2,
-		     osip_from_t * from2);
-
-#endif
-
-#endif				/* endif DOXYGEN */
-
 
 /** 
  * Allocate an osip_t element.
@@ -853,7 +831,7 @@
  * @param dialog The dialog the ACK is part of.
  * @param ack The ACK that has just been sent in response to a 200 Ok.
  * @param dest The destination host.
- * @param sock The destination port.
+ * @param port The destination port.
  * @param sock The socket to be used to send the message. (optional).
  */
   void osip_start_ack_retransmissions (osip_t * osip,
--- libosip2-2.2.0/include/osip2/osip_mt.h
+++ libosip2-2.2.1-alpha/include/osip2/osip_mt.h
@@ -139,7 +139,7 @@
 /** @} */
 
 /**
- * @defgroup oSIP_MUTEX oSIP semaphore definitions
+ * @defgroup oSIP_MUTEX oSIP mutex definitions
  * @ingroup osip2_port
  * @{
  */
@@ -150,13 +150,13 @@
 #endif
 
 /**
- * Structure for referencing a semaphore element.
+ * Structure for referencing a mutex element.
  * @struct osip_mutex
  */
   struct osip_mutex;
 
 /**
- * Allocate and Initialise a semaphore.
+ * Allocate and Initialise a mutex.
  */
   struct osip_mutex *osip_mutex_init (void);
 /**
--- libosip2-2.2.0/include/osip2/osip_time.h	1970-01-01 10:00:00.000000000 +1000
+++ libosip2-2.2.1-alpha/include/osip2/osip_time.h
@@ -0,0 +1,48 @@
+/* To be placed in include/osip2 directory */
+
+#ifndef _OSIP_TIME_H_
+#define _OSIP_TIME_H_
+
+#ifdef __cplusplus
+extern "C"
+{
+#endif
+
+/* Common time-related functions and data types */
+
+/* struct timeval, as defined in <sys/time.h>, <winsock.h> or <winsock2.h> */
+struct timeval;
+
+/* Time manipulation functions */
+void add_gettimeofday(struct timeval *atv,int ms);
+void min_timercmp(struct timeval *tv1,struct timeval *tv2);
+
+/* OS-dependent */
+#if defined(WIN32) || defined(_WIN32_WCE) || defined (__VXWORKS_OS__)
+/* Operations on struct timeval */
+#define osip_timerisset(tvp)         ((tvp)->tv_sec || (tvp)->tv_usec)
+# define osip_timercmp(a, b, CMP)                          \
+  (((a)->tv_sec == (b)->tv_sec) ?                          \
+   ((a)->tv_usec CMP (b)->tv_usec) :                       \
+   ((a)->tv_sec CMP (b)->tv_sec))
+#define osip_timerclear(tvp)         (tvp)->tv_sec = (tvp)->tv_usec = 0
+
+/* osip_gettimeofday() for Windows */
+int osip_gettimeofday(struct timeval *tp,void *tz);
+
+#else
+/* Operations on struct timeval */
+#define osip_timerisset(tvp)            timerisset(tvp)
+#define osip_timercmp(tvp, uvp, cmp)    timercmp(tvp,uvp,cmp)
+#define osip_timerclear(tvp)            timerclear(tvp)
+
+/* osip_gettimeofday() == gettimeofday() */
+#define osip_gettimeofday gettimeofday
+
+#endif /* #ifdef WIN32 */
+
+#ifdef __cplusplus
+}
+#endif
+
+#endif /* #ifndef _OSIP_TIME_H_ */
--- libosip2-2.2.0/include/osipparser2/headers/osip_authentication_info.h
+++ libosip2-2.2.1-alpha/include/osipparser2/headers/osip_authentication_info.h
@@ -28,14 +28,14 @@
  */
 
 /**
- * @defgroup oSIP_TYPES oSIP type definitions
- * @ingroup oSIP
+ * @defgroup oSIP_AUTH_INFO oSIP authentication-info header definition.
+ * @ingroup oSIP_HEADERS
  * @{
  */
 
 /**
- * Structure for WWW-Authenticate headers.
- * @defvar osip_authentication_info_t
+ * Structure for Authentication-Info headers.
+ * @var osip_authentication_info_t
  */
   typedef struct osip_authentication_info osip_authentication_info_t;
 
--- libosip2-2.2.0/include/osipparser2/headers/osip_proxy_authentication_info.h
+++ libosip2-2.2.1-alpha/include/osipparser2/headers/osip_proxy_authentication_info.h
@@ -29,14 +29,14 @@
  */
 
 /**
- * @defgroup oSIP_TYPES oSIP type definitions
- * @ingroup oSIP
+ * @defgroup oSIP_PROXY_AUTH_INFO oSIP proxy-authentication-info header definition.
+ * @ingroup oSIP_HEADERS
  * @{
  */
 
 /**
- * Structure for WWW-Authenticate headers.
- * @defvar osip_authentication_info_t
+ * Structure for Proxy-Authentication-Info headers.
+ * @var osip_proxy_authentication_info_t
  */
   typedef osip_authentication_info_t osip_proxy_authentication_info_t;
 
--- libosip2-2.2.0/include/osipparser2/osip_port.h
+++ libosip2-2.2.1-alpha/include/osipparser2/osip_port.h
@@ -54,12 +54,22 @@
 #endif
 
 #ifdef __VXWORKS_OS__
-
 #include <string.h>
 #include <time.h>
+#include <sys/times.h>
 #include <stdarg.h>
+#include <sys/types.h>
+#include <stdlib.h>
 #define VA_START(a, f)  va_start(a, f)
 
+/* VxWorks lacks support for snprintf */
+int osip_vsnprintf( char* buf, int max, const char *fmt, va_list ap);
+int osip_snprintf(  char *buf, int max, const char *fmt, ...);
+
+#define snprintf  osip_snprintf
+#define vsnprintf osip_vsnprintf
+
+
 #else /* end of __VXWORKS_OS__ */
 
 #if defined (HAVE_CONFIG_H)
--- libosip2-2.2.0/include/osipparser2/sdp_message.h
+++ libosip2-2.2.1-alpha/include/osipparser2/sdp_message.h
@@ -586,7 +586,7 @@
  * @param sdp The element to work on.
  * @param pos_media The line number.
  * @param att_field The value to remove.
- * @param att_field The index of attribute to remove.
+ * @param pos_attr The index of attribute to remove.
  */
   int sdp_message_a_attribute_del_at_index (sdp_message_t * sdp, int pos_media, 
 					    char *att_field, int pos_attr);
--- libosip2-2.2.0/platform/rpm/libosip.spec
+++ libosip2-2.2.1-alpha/platform/rpm/libosip.spec
@@ -6,7 +6,7 @@
 License:	LGPL
 Group:          Development/Libraries
 Source0:	ftp://ftp.gnu.org/gnu/osip/%{name}-%{version}.tar.gz
-URL:		http://www.fsf.org/software/osip/osip.html
+URL:		http://www.gnu.org/software/osip/osip.html
 BuildRequires:	autoconf
 BuildRequires:	automake
 BuildRequires:	libtool
--- libosip2-2.2.0/platform/vsnet/Makefile.am
+++ libosip2-2.2.1-alpha/platform/vsnet/Makefile.am
@@ -1,2 +1,2 @@
-EXTRA_DIST = osip.sln osip2fsm.vcproj osip2parser.vcproj
+EXTRA_DIST = osip.sln osip2.vcproj osipparser2.vcproj
 
--- libosip2-2.2.0/platform/vsnet/osip2fsm.vcproj
+++ libosip2-2.2.1-alpha/platform/vsnet/osip2fsm.vcproj	1970-01-01 10:00:00.000000000 +1000
@@ -1,206 +0,0 @@
-<?xml version="1.0" encoding="Windows-1252"?>
-<VisualStudioProject
-	ProjectType="Visual C++"
-	Version="7.10"
-	Name="osip2fsm"
-	ProjectGUID="{85255507-5D16-4218-85E2-F683BB2F04DA}"
-	Keyword="Win32Proj">
-	<Platforms>
-		<Platform
-			Name="Win32"/>
-	</Platforms>
-	<Configurations>
-		<Configuration
-			Name="Debug|Win32"
-			OutputDirectory="./"
-			IntermediateDirectory="Debug"
-			ConfigurationType="4"
-			CharacterSet="2">
-			<Tool
-				Name="VCCLCompilerTool"
-				Optimization="0"
-				AdditionalIncludeDirectories="..\..\include"
-				PreprocessorDefinitions="WIN32;_DEBUG;_LIB;OSIP_MT;NEW_TIMER;ENABLE_TRACE;USE_TMP_BUFFER"
-				MinimalRebuild="TRUE"
-				BasicRuntimeChecks="3"
-				RuntimeLibrary="1"
-				UsePrecompiledHeader="0"
-				ProgramDataBaseFileName="$(OutDir)/$(ProjectName).pdb"
-				WarningLevel="3"
-				Detect64BitPortabilityProblems="TRUE"
-				DebugInformationFormat="4"/>
-			<Tool
-				Name="VCCustomBuildTool"/>
-			<Tool
-				Name="VCLibrarianTool"
-				OutputFile="$(OutDir)/osip2fsm.lib"/>
-			<Tool
-				Name="VCMIDLTool"/>
-			<Tool
-				Name="VCPostBuildEventTool"/>
-			<Tool
-				Name="VCPreBuildEventTool"/>
-			<Tool
-				Name="VCPreLinkEventTool"/>
-			<Tool
-				Name="VCResourceCompilerTool"/>
-			<Tool
-				Name="VCWebServiceProxyGeneratorTool"/>
-			<Tool
-				Name="VCXMLDataGeneratorTool"/>
-			<Tool
-				Name="VCManagedWrapperGeneratorTool"/>
-			<Tool
-				Name="VCAuxiliaryManagedWrapperGeneratorTool"/>
-		</Configuration>
-		<Configuration
-			Name="Release|Win32"
-			OutputDirectory="Release"
-			IntermediateDirectory="Release"
-			ConfigurationType="4"
-			CharacterSet="2">
-			<Tool
-				Name="VCCLCompilerTool"
-				PreprocessorDefinitions="WIN32;NDEBUG;_LIB"
-				RuntimeLibrary="4"
-				UsePrecompiledHeader="0"
-				WarningLevel="3"
-				Detect64BitPortabilityProblems="TRUE"
-				DebugInformationFormat="3"/>
-			<Tool
-				Name="VCCustomBuildTool"/>
-			<Tool
-				Name="VCLibrarianTool"
-				OutputFile="$(OutDir)/osip2fsm.lib"/>
-			<Tool
-				Name="VCMIDLTool"/>
-			<Tool
-				Name="VCPostBuildEventTool"/>
-			<Tool
-				Name="VCPreBuildEventTool"/>
-			<Tool
-				Name="VCPreLinkEventTool"/>
-			<Tool
-				Name="VCResourceCompilerTool"/>
-			<Tool
-				Name="VCWebServiceProxyGeneratorTool"/>
-			<Tool
-				Name="VCXMLDataGeneratorTool"/>
-			<Tool
-				Name="VCManagedWrapperGeneratorTool"/>
-			<Tool
-				Name="VCAuxiliaryManagedWrapperGeneratorTool"/>
-		</Configuration>
-	</Configurations>
-	<References>
-	</References>
-	<Files>
-		<Filter
-			Name="Source Files"
-			Filter="cpp;c;cxx;def;odl;idl;hpj;bat;asm;asmx"
-			UniqueIdentifier="{4FC737F1-C7A5-4376-A066-2A32D752A2FF}">
-			<File
-				RelativePath="..\..\src\osip2\fsm_misc.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osip2\ict.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osip2\ict_fsm.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osip2\ist.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osip2\ist_fsm.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osip2\nict.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osip2\nict_fsm.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osip2\nist.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osip2\nist_fsm.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osip2\osip.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osip2\osip_dialog.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osip2\osip_event.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osip2\osip_negotiation.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osip2\osip_time.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osip2\osip_transaction.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osip2\port_condv.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osip2\port_fifo.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osip2\port_sema.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osip2\port_thread.c">
-			</File>
-		</Filter>
-		<Filter
-			Name="Header Files"
-			Filter="h;hpp;hxx;hm;inl;inc;xsd"
-			UniqueIdentifier="{93995380-89BD-4b04-88EB-625FBE52EBFB}">
-			<File
-				RelativePath="..\..\src\osip2\fsm.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osip2\internal.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osip2\osip.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osip2\osip_condv.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osip2\osip_dialog.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osip2\osip_fifo.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osip2\osip_mt.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osip2\osip_negotiation.h">
-			</File>
-			<File
-				RelativePath="..\..\src\osip2\xixt.h">
-			</File>
-		</Filter>
-		<Filter
-			Name="Resource Files"
-			Filter="rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx"
-			UniqueIdentifier="{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}">
-		</Filter>
-		<File
-			RelativePath=".\osip2fsm.lib">
-		</File>
-		<File
-			RelativePath=".\osip2fsm.pdb">
-		</File>
-	</Files>
-	<Globals>
-	</Globals>
-</VisualStudioProject>
--- libosip2-2.2.0/platform/vsnet/osip2parser.vcproj
+++ libosip2-2.2.1-alpha/platform/vsnet/osip2parser.vcproj	1970-01-01 10:00:00.000000000 +1000
@@ -1,338 +0,0 @@
-<?xml version="1.0" encoding="Windows-1252"?>
-<VisualStudioProject
-	ProjectType="Visual C++"
-	Version="7.10"
-	Name="osip2parser"
-	ProjectGUID="{44F46B7E-0E51-4304-9735-330DFBAB41E5}"
-	Keyword="Win32Proj">
-	<Platforms>
-		<Platform
-			Name="Win32"/>
-	</Platforms>
-	<Configurations>
-		<Configuration
-			Name="Debug|Win32"
-			OutputDirectory="./"
-			IntermediateDirectory="Debug"
-			ConfigurationType="4"
-			CharacterSet="2">
-			<Tool
-				Name="VCCLCompilerTool"
-				Optimization="0"
-				AdditionalIncludeDirectories="..\..\include"
-				PreprocessorDefinitions="WIN32;_DEBUG;_LIB;OSIP_MT;NEW_TIMER;ENABLE_TRACE;USE_TMP_BUFFER"
-				MinimalRebuild="TRUE"
-				BasicRuntimeChecks="3"
-				RuntimeLibrary="1"
-				UsePrecompiledHeader="0"
-				ProgramDataBaseFileName="$(OutDir)/$(ProjectName).pdb"
-				WarningLevel="3"
-				Detect64BitPortabilityProblems="TRUE"
-				DebugInformationFormat="4"/>
-			<Tool
-				Name="VCCustomBuildTool"/>
-			<Tool
-				Name="VCLibrarianTool"
-				OutputFile="$(OutDir)/osip2parser.lib"/>
-			<Tool
-				Name="VCMIDLTool"/>
-			<Tool
-				Name="VCPostBuildEventTool"/>
-			<Tool
-				Name="VCPreBuildEventTool"/>
-			<Tool
-				Name="VCPreLinkEventTool"/>
-			<Tool
-				Name="VCResourceCompilerTool"/>
-			<Tool
-				Name="VCWebServiceProxyGeneratorTool"/>
-			<Tool
-				Name="VCXMLDataGeneratorTool"/>
-			<Tool
-				Name="VCManagedWrapperGeneratorTool"/>
-			<Tool
-				Name="VCAuxiliaryManagedWrapperGeneratorTool"/>
-		</Configuration>
-		<Configuration
-			Name="Release|Win32"
-			OutputDirectory="Release"
-			IntermediateDirectory="Release"
-			ConfigurationType="4"
-			CharacterSet="2">
-			<Tool
-				Name="VCCLCompilerTool"
-				PreprocessorDefinitions="WIN32;NDEBUG;_LIB"
-				RuntimeLibrary="4"
-				UsePrecompiledHeader="0"
-				WarningLevel="3"
-				Detect64BitPortabilityProblems="TRUE"
-				DebugInformationFormat="3"/>
-			<Tool
-				Name="VCCustomBuildTool"/>
-			<Tool
-				Name="VCLibrarianTool"
-				OutputFile="$(OutDir)/osip2parser.lib"/>
-			<Tool
-				Name="VCMIDLTool"/>
-			<Tool
-				Name="VCPostBuildEventTool"/>
-			<Tool
-				Name="VCPreBuildEventTool"/>
-			<Tool
-				Name="VCPreLinkEventTool"/>
-			<Tool
-				Name="VCResourceCompilerTool"/>
-			<Tool
-				Name="VCWebServiceProxyGeneratorTool"/>
-			<Tool
-				Name="VCXMLDataGeneratorTool"/>
-			<Tool
-				Name="VCManagedWrapperGeneratorTool"/>
-			<Tool
-				Name="VCAuxiliaryManagedWrapperGeneratorTool"/>
-		</Configuration>
-	</Configurations>
-	<References>
-	</References>
-	<Files>
-		<Filter
-			Name="Source Files"
-			Filter="cpp;c;cxx;def;odl;idl;hpj;bat;asm;asmx"
-			UniqueIdentifier="{4FC737F1-C7A5-4376-A066-2A32D752A2FF}">
-			<File
-				RelativePath="..\..\src\osipparser2\osip_accept.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_accept_encoding.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_accept_language.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_alert_info.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_allow.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_authorization.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_body.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_call_id.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_call_info.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_contact.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_content_disposition.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_content_encoding.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_content_length.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_content_type.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_cseq.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_error_info.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_from.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_header.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_list.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_md5c.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_message.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_message_parse.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_message_to_str.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_mime_version.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_parser_cfg.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_port.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_proxy_authenticate.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_proxy_authorization.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_record_route.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_route.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_to.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_uri.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_via.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\osip_www_authenticate.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\sdp_accessor.c">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\sdp_message.c">
-			</File>
-		</Filter>
-		<Filter
-			Name="Header Files"
-			Filter="h;hpp;hxx;hm;inl;inc;xsd"
-			UniqueIdentifier="{93995380-89BD-4b04-88EB-625FBE52EBFB}">
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_accept.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_accept_encoding.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_accept_language.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_alert_info.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_allow.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_authorization.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\osip_body.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_call_id.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_call_info.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\osip_const.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_contact.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_content_disposition.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_content_encoding.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_content_length.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_content_type.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_cseq.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_error_info.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_from.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_header.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\osip_headers.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\osip_list.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\osip_md5.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\osip_message.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_mime_version.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\osip_parser.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\osip_port.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_proxy_authenticate.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_proxy_authorization.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_record_route.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_route.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_to.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\osip_uri.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_via.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\headers\osip_www_authenticate.h">
-			</File>
-			<File
-				RelativePath="..\..\src\osipparser2\parser.h">
-			</File>
-			<File
-				RelativePath="..\..\include\osipparser2\sdp_message.h">
-			</File>
-		</Filter>
-		<Filter
-			Name="Resource Files"
-			Filter="rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx"
-			UniqueIdentifier="{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}">
-		</Filter>
-		<File
-			RelativePath=".\osip2parser.lib">
-		</File>
-		<File
-			RelativePath=".\osip2parser.pdb">
-		</File>
-	</Files>
-	<Globals>
-	</Globals>
-</VisualStudioProject>
--- libosip2-2.2.0/platform/vsnet/osip2.vcproj	1970-01-01 10:00:00.000000000 +1000
+++ libosip2-2.2.1-alpha/platform/vsnet/osip2.vcproj
@@ -0,0 +1,202 @@
+<?xml version="1.0" encoding="Windows-1252"?>
+<VisualStudioProject
+	ProjectType="Visual C++"
+	Version="7.10"
+	Name="osip2"
+	ProjectGUID="{85255507-5D16-4218-85E2-F683BB2F04DA}"
+	Keyword="Win32Proj">
+	<Platforms>
+		<Platform
+			Name="Win32"/>
+	</Platforms>
+	<Configurations>
+		<Configuration
+			Name="Debug|Win32"
+			OutputDirectory="Debug"
+			IntermediateDirectory="Debug"
+			ConfigurationType="4"
+			CharacterSet="2">
+			<Tool
+				Name="VCCLCompilerTool"
+				Optimization="0"
+				AdditionalIncludeDirectories="..\..\include"
+				PreprocessorDefinitions="WIN32;_DEBUG;_LIB;OSIP_MT;ENABLE_TRACE"
+				MinimalRebuild="TRUE"
+				BasicRuntimeChecks="3"
+				RuntimeLibrary="1"
+				UsePrecompiledHeader="0"
+				ProgramDataBaseFileName="$(OutDir)/$(ProjectName).pdb"
+				WarningLevel="3"
+				Detect64BitPortabilityProblems="TRUE"
+				DebugInformationFormat="4"/>
+			<Tool
+				Name="VCCustomBuildTool"/>
+			<Tool
+				Name="VCLibrarianTool"
+				OutputFile="$(OutDir)\osip2.lib"/>
+			<Tool
+				Name="VCMIDLTool"/>
+			<Tool
+				Name="VCPostBuildEventTool"/>
+			<Tool
+				Name="VCPreBuildEventTool"/>
+			<Tool
+				Name="VCPreLinkEventTool"/>
+			<Tool
+				Name="VCResourceCompilerTool"/>
+			<Tool
+				Name="VCWebServiceProxyGeneratorTool"/>
+			<Tool
+				Name="VCXMLDataGeneratorTool"/>
+			<Tool
+				Name="VCManagedWrapperGeneratorTool"/>
+			<Tool
+				Name="VCAuxiliaryManagedWrapperGeneratorTool"/>
+		</Configuration>
+		<Configuration
+			Name="Release|Win32"
+			OutputDirectory="Release"
+			IntermediateDirectory="Release"
+			ConfigurationType="4"
+			CharacterSet="2">
+			<Tool
+				Name="VCCLCompilerTool"
+				AdditionalIncludeDirectories="..\..\include"
+				PreprocessorDefinitions="WIN32;NDEBUG;_LIB;OSIP_MT"
+				RuntimeLibrary="0"
+				UsePrecompiledHeader="0"
+				ProgramDataBaseFileName="$(OutDir)/$(ProjectName).pdb"
+				WarningLevel="3"
+				Detect64BitPortabilityProblems="TRUE"
+				DebugInformationFormat="3"/>
+			<Tool
+				Name="VCCustomBuildTool"/>
+			<Tool
+				Name="VCLibrarianTool"
+				OutputFile="$(OutDir)\osip2.lib"/>
+			<Tool
+				Name="VCMIDLTool"/>
+			<Tool
+				Name="VCPostBuildEventTool"/>
+			<Tool
+				Name="VCPreBuildEventTool"/>
+			<Tool
+				Name="VCPreLinkEventTool"/>
+			<Tool
+				Name="VCResourceCompilerTool"/>
+			<Tool
+				Name="VCWebServiceProxyGeneratorTool"/>
+			<Tool
+				Name="VCXMLDataGeneratorTool"/>
+			<Tool
+				Name="VCManagedWrapperGeneratorTool"/>
+			<Tool
+				Name="VCAuxiliaryManagedWrapperGeneratorTool"/>
+		</Configuration>
+	</Configurations>
+	<References>
+	</References>
+	<Files>
+		<Filter
+			Name="Source Files"
+			Filter="cpp;c;cxx;def;odl;idl;hpj;bat;asm;asmx"
+			UniqueIdentifier="{4FC737F1-C7A5-4376-A066-2A32D752A2FF}">
+			<File
+				RelativePath="..\..\src\osip2\fsm_misc.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osip2\ict.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osip2\ict_fsm.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osip2\ist.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osip2\ist_fsm.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osip2\nict.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osip2\nict_fsm.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osip2\nist.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osip2\nist_fsm.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osip2\osip.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osip2\osip_dialog.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osip2\osip_event.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osip2\osip_negotiation.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osip2\osip_time.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osip2\osip_transaction.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osip2\port_condv.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osip2\port_fifo.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osip2\port_sema.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osip2\port_thread.c">
+			</File>
+		</Filter>
+		<Filter
+			Name="Header Files"
+			Filter="h;hpp;hxx;hm;inl;inc;xsd"
+			UniqueIdentifier="{93995380-89BD-4b04-88EB-625FBE52EBFB}">
+			<File
+				RelativePath="..\..\src\osip2\fsm.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osip2\internal.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osip2\osip.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osip2\osip_condv.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osip2\osip_dialog.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osip2\osip_fifo.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osip2\osip_mt.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osip2\osip_negotiation.h">
+			</File>
+			<File
+				RelativePath="..\..\src\osip2\xixt.h">
+			</File>
+		</Filter>
+		<Filter
+			Name="Resource Files"
+			Filter="rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx"
+			UniqueIdentifier="{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}">
+		</Filter>
+	</Files>
+	<Globals>
+	</Globals>
+</VisualStudioProject>
--- libosip2-2.2.0/platform/vsnet/osipparser2.vcproj	1970-01-01 10:00:00.000000000 +1000
+++ libosip2-2.2.1-alpha/platform/vsnet/osipparser2.vcproj
@@ -0,0 +1,340 @@
+<?xml version="1.0" encoding="Windows-1252"?>
+<VisualStudioProject
+	ProjectType="Visual C++"
+	Version="7.10"
+	Name="osipparser2"
+	ProjectGUID="{44F46B7E-0E51-4304-9735-330DFBAB41E5}"
+	Keyword="Win32Proj">
+	<Platforms>
+		<Platform
+			Name="Win32"/>
+	</Platforms>
+	<Configurations>
+		<Configuration
+			Name="Debug|Win32"
+			OutputDirectory="Debug"
+			IntermediateDirectory="Debug"
+			ConfigurationType="4"
+			CharacterSet="2">
+			<Tool
+				Name="VCCLCompilerTool"
+				Optimization="0"
+				AdditionalIncludeDirectories="..\..\include"
+				PreprocessorDefinitions="WIN32;_DEBUG;_LIB;OSIP_MT;NEW_TIMER;ENABLE_TRACE;USE_TMP_BUFFER"
+				MinimalRebuild="TRUE"
+				BasicRuntimeChecks="3"
+				RuntimeLibrary="1"
+				UsePrecompiledHeader="0"
+				ProgramDataBaseFileName="$(OutDir)/$(ProjectName).pdb"
+				WarningLevel="3"
+				Detect64BitPortabilityProblems="TRUE"
+				DebugInformationFormat="4"/>
+			<Tool
+				Name="VCCustomBuildTool"/>
+			<Tool
+				Name="VCLibrarianTool"
+				OutputFile="$(OutDir)\osipparser2.lib"/>
+			<Tool
+				Name="VCMIDLTool"/>
+			<Tool
+				Name="VCPostBuildEventTool"/>
+			<Tool
+				Name="VCPreBuildEventTool"/>
+			<Tool
+				Name="VCPreLinkEventTool"/>
+			<Tool
+				Name="VCResourceCompilerTool"/>
+			<Tool
+				Name="VCWebServiceProxyGeneratorTool"/>
+			<Tool
+				Name="VCXMLDataGeneratorTool"/>
+			<Tool
+				Name="VCManagedWrapperGeneratorTool"/>
+			<Tool
+				Name="VCAuxiliaryManagedWrapperGeneratorTool"/>
+		</Configuration>
+		<Configuration
+			Name="Release|Win32"
+			OutputDirectory="Release"
+			IntermediateDirectory="Release"
+			ConfigurationType="4"
+			CharacterSet="2">
+			<Tool
+				Name="VCCLCompilerTool"
+				AdditionalIncludeDirectories="..\..\include"
+				PreprocessorDefinitions="WIN32;NDEBUG;_LIB"
+				RuntimeLibrary="0"
+				UsePrecompiledHeader="0"
+				ProgramDataBaseFileName="$(OutDir)/$(ProjectName).pdb"
+				WarningLevel="3"
+				Detect64BitPortabilityProblems="TRUE"
+				DebugInformationFormat="3"/>
+			<Tool
+				Name="VCCustomBuildTool"/>
+			<Tool
+				Name="VCLibrarianTool"
+				OutputFile="$(OutDir)/osipparser2.lib"/>
+			<Tool
+				Name="VCMIDLTool"/>
+			<Tool
+				Name="VCPostBuildEventTool"/>
+			<Tool
+				Name="VCPreBuildEventTool"/>
+			<Tool
+				Name="VCPreLinkEventTool"/>
+			<Tool
+				Name="VCResourceCompilerTool"/>
+			<Tool
+				Name="VCWebServiceProxyGeneratorTool"/>
+			<Tool
+				Name="VCXMLDataGeneratorTool"/>
+			<Tool
+				Name="VCManagedWrapperGeneratorTool"/>
+			<Tool
+				Name="VCAuxiliaryManagedWrapperGeneratorTool"/>
+		</Configuration>
+	</Configurations>
+	<References>
+	</References>
+	<Files>
+		<Filter
+			Name="Source Files"
+			Filter="cpp;c;cxx;def;odl;idl;hpj;bat;asm;asmx"
+			UniqueIdentifier="{4FC737F1-C7A5-4376-A066-2A32D752A2FF}">
+			<File
+				RelativePath="..\..\src\osipparser2\osip_accept.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_accept_encoding.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_accept_language.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_alert_info.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_allow.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_authentication_info.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_authorization.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_body.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_call_id.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_call_info.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_contact.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_content_disposition.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_content_encoding.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_content_length.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_content_type.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_cseq.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_error_info.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_from.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_header.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_list.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_md5c.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_message.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_message_parse.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_message_to_str.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_mime_version.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_parser_cfg.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_port.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_proxy_authenticate.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_proxy_authentication_info.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_proxy_authorization.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_record_route.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_route.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_to.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_uri.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_via.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\osip_www_authenticate.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\sdp_accessor.c">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\sdp_message.c">
+			</File>
+		</Filter>
+		<Filter
+			Name="Header Files"
+			Filter="h;hpp;hxx;hm;inl;inc;xsd"
+			UniqueIdentifier="{93995380-89BD-4b04-88EB-625FBE52EBFB}">
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_accept.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_accept_encoding.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_accept_language.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_alert_info.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_allow.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_authorization.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\osip_body.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_call_id.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_call_info.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\osip_const.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_contact.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_content_disposition.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_content_encoding.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_content_length.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_content_type.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_cseq.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_error_info.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_from.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_header.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\osip_headers.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\osip_list.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\osip_md5.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\osip_message.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_mime_version.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\osip_parser.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\osip_port.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_proxy_authenticate.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_proxy_authorization.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_record_route.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_route.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_to.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\osip_uri.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_via.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\headers\osip_www_authenticate.h">
+			</File>
+			<File
+				RelativePath="..\..\src\osipparser2\parser.h">
+			</File>
+			<File
+				RelativePath="..\..\include\osipparser2\sdp_message.h">
+			</File>
+		</Filter>
+		<Filter
+			Name="Resource Files"
+			Filter="rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx"
+			UniqueIdentifier="{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}">
+		</Filter>
+	</Files>
+	<Globals>
+	</Globals>
+</VisualStudioProject>
--- libosip2-2.2.0/platform/vsnet/osip.sln
+++ libosip2-2.2.1-alpha/platform/vsnet/osip.sln
@@ -1,29 +1,30 @@
-Microsoft Visual Studio Solution File, Format Version 8.00
-Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "osip2fsm", "osip2fsm.vcproj", "{85255507-5D16-4218-85E2-F683BB2F04DA}"
-	ProjectSection(ProjectDependencies) = postProject
-	EndProjectSection
-EndProject
-Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "osip2parser", "osip2parser.vcproj", "{44F46B7E-0E51-4304-9735-330DFBAB41E5}"
-	ProjectSection(ProjectDependencies) = postProject
-	EndProjectSection
-EndProject
-Global
-	GlobalSection(SolutionConfiguration) = preSolution
-		Debug = Debug
-		Release = Release
-	EndGlobalSection
-	GlobalSection(ProjectConfiguration) = postSolution
-		{85255507-5D16-4218-85E2-F683BB2F04DA}.Debug.ActiveCfg = Debug|Win32
-		{85255507-5D16-4218-85E2-F683BB2F04DA}.Debug.Build.0 = Debug|Win32
-		{85255507-5D16-4218-85E2-F683BB2F04DA}.Release.ActiveCfg = Release|Win32
-		{85255507-5D16-4218-85E2-F683BB2F04DA}.Release.Build.0 = Release|Win32
-		{44F46B7E-0E51-4304-9735-330DFBAB41E5}.Debug.ActiveCfg = Debug|Win32
-		{44F46B7E-0E51-4304-9735-330DFBAB41E5}.Debug.Build.0 = Debug|Win32
-		{44F46B7E-0E51-4304-9735-330DFBAB41E5}.Release.ActiveCfg = Release|Win32
-		{44F46B7E-0E51-4304-9735-330DFBAB41E5}.Release.Build.0 = Release|Win32
-	EndGlobalSection
-	GlobalSection(ExtensibilityGlobals) = postSolution
-	EndGlobalSection
-	GlobalSection(ExtensibilityAddIns) = postSolution
-	EndGlobalSection
-EndGlobal
+Microsoft Visual Studio Solution File, Format Version 8.00
+Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "osip2", "osip2.vcproj", "{85255507-5D16-4218-85E2-F683BB2F04DA}"
+	ProjectSection(ProjectDependencies) = postProject
+		{44F46B7E-0E51-4304-9735-330DFBAB41E5} = {44F46B7E-0E51-4304-9735-330DFBAB41E5}
+	EndProjectSection
+EndProject
+Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "osipparser2", "osipparser2.vcproj", "{44F46B7E-0E51-4304-9735-330DFBAB41E5}"
+	ProjectSection(ProjectDependencies) = postProject
+	EndProjectSection
+EndProject
+Global
+	GlobalSection(SolutionConfiguration) = preSolution
+		Debug = Debug
+		Release = Release
+	EndGlobalSection
+	GlobalSection(ProjectConfiguration) = postSolution
+		{85255507-5D16-4218-85E2-F683BB2F04DA}.Debug.ActiveCfg = Debug|Win32
+		{85255507-5D16-4218-85E2-F683BB2F04DA}.Debug.Build.0 = Debug|Win32
+		{85255507-5D16-4218-85E2-F683BB2F04DA}.Release.ActiveCfg = Release|Win32
+		{85255507-5D16-4218-85E2-F683BB2F04DA}.Release.Build.0 = Release|Win32
+		{44F46B7E-0E51-4304-9735-330DFBAB41E5}.Debug.ActiveCfg = Debug|Win32
+		{44F46B7E-0E51-4304-9735-330DFBAB41E5}.Debug.Build.0 = Debug|Win32
+		{44F46B7E-0E51-4304-9735-330DFBAB41E5}.Release.ActiveCfg = Release|Win32
+		{44F46B7E-0E51-4304-9735-330DFBAB41E5}.Release.Build.0 = Release|Win32
+	EndGlobalSection
+	GlobalSection(ExtensibilityGlobals) = postSolution
+	EndGlobalSection
+	GlobalSection(ExtensibilityAddIns) = postSolution
+	EndGlobalSection
+EndGlobal
--- libosip2-2.2.0/platform/windows/osip2.def
+++ libosip2-2.2.1-alpha/platform/windows/osip2.def
@@ -131,3 +131,5 @@
      osip_start_ack_retransmissions @131
      osip_stop_200ok_retransmissions @132
      osip_stop_retransmissions_from_dialog @133
+     osip_gettimeofday @134
+
--- libosip2-2.2.0/platform/windows/osip2.dsp
+++ libosip2-2.2.1-alpha/platform/windows/osip2.dsp
@@ -208,6 +208,10 @@
 # End Source File
 # Begin Source File
 
+SOURCE=..\..\include\osip2\osip_time.h
+# End Source File
+# Begin Source File
+
 SOURCE=..\..\src\osip2\xixt.h
 # End Source File
 # End Group
--- libosip2-2.2.0/README
+++ libosip2-2.2.1-alpha/README
@@ -5,11 +5,11 @@
 
  Email      : jack@atosc.org
  License    : LGPL (http://www.gnu.org)
- Home Page  : http://www.fsf.org/software/osip/osip.html
+ Home Page  : http://www.gnu.org/software/osip/osip.html
  Download   : ftp://ftp.gnu.org/gnu/osip
 
 "The GNU oSIP library" is part of the "GNU project".
-You can check www.fsf.org for more information about
+You can check www.gnu.org for more information about
 being part of the "GNU project".
 
 For information, look at:
@@ -21,7 +21,7 @@
        =====
 
 Latest version:       ftp://ftp.gnu.org/gnu/osip
-Home page:            http://www.fsf.org/software/osip/osip.html
+Home page:            http://www.gnu.org/software/osip/osip.html
 Online Documentation: http://www.gnu.org/software/osip/
 
        Supported Platforms:
--- libosip2-2.2.0/src/osip2/fsm.h
+++ libosip2-2.2.1-alpha/src/osip2/fsm.h
@@ -27,12 +27,6 @@
 
 #ifndef DOXYGEN
 
-void add_gettimeofday (struct timeval *atv, int ms);
-void min_timercmp (struct timeval *tv1, struct timeval *tv2);
-#ifdef WIN32
-int gettimeofday(struct timeval *tp, void *tz);
-#endif
-
 typedef struct osip_statemachine osip_statemachine_t;
 
 struct osip_statemachine
--- libosip2-2.2.0/src/osip2/ict.c
+++ libosip2-2.2.1-alpha/src/osip2/ict.c
@@ -52,8 +52,9 @@
     if (proto == NULL)
       goto ii_error_1;
 
-    i = osip_strncasecmp (proto, "TCP", 3);
-    if (i != 0)
+    if (osip_strcasecmp (proto, "TCP") != 0
+	&& osip_strcasecmp (proto, "TLS") !=0
+	&& osip_strcasecmp (proto, "SCTP") !=0)
       {				/* for other reliable protocol than TCP, the timer
 				   must be desactived by the external application */
 	(*ict)->timer_a_length = DEFAULT_T1;
@@ -61,12 +62,12 @@
 	  (*ict)->timer_d_length = 32000;
 	else
 	  (*ict)->timer_d_length = 64 * DEFAULT_T1;
-	gettimeofday (&(*ict)->timer_a_start, NULL);
+	osip_gettimeofday (&(*ict)->timer_a_start, NULL);
 	add_gettimeofday (&(*ict)->timer_a_start, (*ict)->timer_a_length);
 	(*ict)->timer_d_start.tv_sec = -1;	/* not started */
       }
     else
-      {				/* TCP is used: */
+      {				/* reliable protocol is used: */
 	(*ict)->timer_a_length = -1;	/* A is not ACTIVE */
 	(*ict)->timer_d_length = 0;	/* MUST do the transition immediatly */
 	(*ict)->timer_a_start.tv_sec = -1;	/* not started */
@@ -89,7 +90,7 @@
     (*ict)->port = 5060;
 
   (*ict)->timer_b_length = 64 * DEFAULT_T1;
-  gettimeofday (&(*ict)->timer_b_start, NULL);
+  osip_gettimeofday (&(*ict)->timer_b_start, NULL);
   add_gettimeofday (&(*ict)->timer_b_start, (*ict)->timer_b_length);
 
   /* Oups! A bug! */
@@ -131,7 +132,7 @@
 __osip_ict_need_timer_a_event (osip_ict_t * ict, state_t state, int transactionid)
 {
   struct timeval now;
-  gettimeofday (&now, NULL);
+  osip_gettimeofday (&now, NULL);
 
   if (ict == NULL)
     return NULL;
@@ -140,7 +141,7 @@
       /* may need timer A */
       if (ict->timer_a_start.tv_sec == -1)
 	return NULL;
-      if (timercmp (&now, &ict->timer_a_start, >))
+      if (osip_timercmp (&now, &ict->timer_a_start, >))
 	return __osip_event_new (TIMEOUT_A, transactionid);
     }
   return NULL;
@@ -151,7 +152,7 @@
 			       int transactionid)
 {
   struct timeval now;
-  gettimeofday (&now, NULL);
+  osip_gettimeofday (&now, NULL);
 
   if (ict == NULL)
     return NULL;
@@ -160,7 +161,7 @@
       /* may need timer B */
       if (ict->timer_b_start.tv_sec == -1)
 	return NULL;
-      if (timercmp (&now, &ict->timer_b_start, >))
+      if (osip_timercmp (&now, &ict->timer_b_start, >))
 	return __osip_event_new (TIMEOUT_B, transactionid);
     }
   return NULL;
@@ -171,7 +172,7 @@
 			       int transactionid)
 {
   struct timeval now;
-  gettimeofday (&now, NULL);
+  osip_gettimeofday (&now, NULL);
 
   if (ict == NULL)
     return NULL;
@@ -180,7 +181,7 @@
       /* may need timer D */
       if (ict->timer_d_start.tv_sec == -1)
 	return NULL;
-      if (timercmp (&now, &ict->timer_d_start, >))
+      if (osip_timercmp (&now, &ict->timer_d_start, >))
 	return __osip_event_new (TIMEOUT_D, transactionid);
     }
   return NULL;
--- libosip2-2.2.0/src/osip2/ict_fsm.c
+++ libosip2-2.2.1-alpha/src/osip2/ict_fsm.c
@@ -178,7 +178,7 @@
 
   /* reset timer */
   ict->ict_context->timer_a_length = ict->ict_context->timer_a_length * 2;
-  gettimeofday (&ict->ict_context->timer_a_start, NULL);
+  osip_gettimeofday (&ict->ict_context->timer_a_start, NULL);
   add_gettimeofday (&ict->ict_context->timer_a_start,
 		    ict->ict_context->timer_a_length);
 
@@ -412,7 +412,7 @@
    */
 
   /* start timer D (length is set to MAX (64*DEFAULT_T1 or 32000) */
-  gettimeofday (&ict->ict_context->timer_d_start, NULL);
+  osip_gettimeofday (&ict->ict_context->timer_d_start, NULL);
   add_gettimeofday (&ict->ict_context->timer_d_start,
 		    ict->ict_context->timer_d_length);
   __osip_transaction_set_state (ict, ICT_COMPLETED);
--- libosip2-2.2.0/src/osip2/ist.c
+++ libosip2-2.2.1-alpha/src/osip2/ist.c
@@ -47,8 +47,9 @@
     if (proto == NULL)
       goto ii_error_1;
 
-    i = osip_strncasecmp (proto, "TCP", 3);
-    if (i != 0)
+    if (osip_strcasecmp (proto, "TCP") != 0
+	&& osip_strcasecmp (proto, "TLS") !=0
+	&& osip_strcasecmp (proto, "SCTP") !=0)
       {				/* for other reliable protocol than TCP, the timer
 				   must be desactived by the external application */
 	(*ist)->timer_g_length = DEFAULT_T1;
@@ -57,7 +58,7 @@
 	(*ist)->timer_i_start.tv_sec = -1;	/* not started */
       }
     else
-      {				/* TCP is used: */
+      {				/* reliable protocol is used: */
 	(*ist)->timer_g_length = -1;	/* A is not ACTIVE */
 	(*ist)->timer_i_length = 0;	/* MUST do the transition immediatly */
 	(*ist)->timer_g_start.tv_sec = -1;	/* not started */
@@ -90,7 +91,7 @@
 __osip_ist_need_timer_g_event (osip_ist_t * ist, state_t state, int transactionid)
 {
   struct timeval now;
-  gettimeofday (&now, NULL);
+  osip_gettimeofday (&now, NULL);
 
   if (ist == NULL)
     return NULL;
@@ -98,7 +99,7 @@
     {
       if (ist->timer_g_start.tv_sec == -1)
 	return NULL;
-      if (timercmp (&now, &ist->timer_g_start, >))
+      if (osip_timercmp (&now, &ist->timer_g_start, >))
 	return __osip_event_new (TIMEOUT_G, transactionid);
     }
   return NULL;
@@ -109,7 +110,7 @@
 			       int transactionid)
 {
   struct timeval now;
-  gettimeofday (&now, NULL);
+  osip_gettimeofday (&now, NULL);
 
   if (ist == NULL)
     return NULL;
@@ -118,7 +119,7 @@
       /* may need timer H */
       if (ist->timer_h_start.tv_sec == -1)
 	return NULL;
-      if (timercmp (&now, &ist->timer_h_start, >))
+      if (osip_timercmp (&now, &ist->timer_h_start, >))
 	return __osip_event_new (TIMEOUT_H, transactionid);
     }
   return NULL;
@@ -129,7 +130,7 @@
 			       int transactionid)
 {
   struct timeval now;
-  gettimeofday (&now, NULL);
+  osip_gettimeofday (&now, NULL);
 
   if (ist == NULL)
     return NULL;
@@ -138,7 +139,7 @@
       /* may need timer I */
       if (ist->timer_i_start.tv_sec == -1)
 	return NULL;
-      if (timercmp (&now, &ist->timer_i_start, >))
+      if (osip_timercmp (&now, &ist->timer_i_start, >))
 	return __osip_event_new (TIMEOUT_I, transactionid);
     }
   return NULL;
--- libosip2-2.2.0/src/osip2/ist_fsm.c
+++ libosip2-2.2.1-alpha/src/osip2/ist_fsm.c
@@ -287,7 +287,7 @@
   ist->ist_context->timer_g_length = ist->ist_context->timer_g_length * 2;
   if (ist->ist_context->timer_g_length > 4000)
     ist->ist_context->timer_g_length = 4000;
-  gettimeofday (&ist->ist_context->timer_g_start, NULL);
+  osip_gettimeofday (&ist->ist_context->timer_g_start, NULL);
   add_gettimeofday (&ist->ist_context->timer_g_start,
 		    ist->ist_context->timer_g_length);
 
@@ -573,11 +573,11 @@
 
   if(ist->ist_context->timer_g_length != -1)
     {
-      gettimeofday (&ist->ist_context->timer_g_start, NULL);
+      osip_gettimeofday (&ist->ist_context->timer_g_start, NULL);
       add_gettimeofday (&ist->ist_context->timer_g_start,
 			ist->ist_context->timer_g_length);
     }
-  gettimeofday (&ist->ist_context->timer_h_start, NULL);
+  osip_gettimeofday (&ist->ist_context->timer_h_start, NULL);
   add_gettimeofday (&ist->ist_context->timer_h_start,
 		    ist->ist_context->timer_h_length);
   __osip_transaction_set_state (ist, IST_COMPLETED);
@@ -599,7 +599,7 @@
   else				/* IST_CONFIRMED */
     __osip_message_callback (OSIP_IST_ACK_RECEIVED_AGAIN, ist, ist->ack);
   /* set the timer to 0 for reliable, and T4 for unreliable (already set) */
-  gettimeofday (&ist->ist_context->timer_i_start, NULL);
+  osip_gettimeofday (&ist->ist_context->timer_i_start, NULL);
   add_gettimeofday (&ist->ist_context->timer_i_start,
 		    ist->ist_context->timer_i_length);
   __osip_transaction_set_state (ist, IST_CONFIRMED);
--- libosip2-2.2.0/src/osip2/nict.c
+++ libosip2-2.2.1-alpha/src/osip2/nict.c
@@ -52,17 +52,18 @@
     if (proto == NULL)
       goto ii_error_1;
 
-    i = osip_strncasecmp (proto, "TCP", 3);
-    if (i != 0)
+    if (osip_strcasecmp (proto, "TCP") != 0
+	&& osip_strcasecmp (proto, "TLS") !=0
+	&& osip_strcasecmp (proto, "SCTP") !=0)
       {
 	(*nict)->timer_e_length = DEFAULT_T1;
 	(*nict)->timer_k_length = DEFAULT_T4;
-	gettimeofday (&(*nict)->timer_e_start, NULL);
+	osip_gettimeofday (&(*nict)->timer_e_start, NULL);
 	add_gettimeofday (&(*nict)->timer_e_start, (*nict)->timer_e_length);
 	(*nict)->timer_k_start.tv_sec = -1;	/* not started */
       }
     else
-      {				/* TCP is used: */
+      {				/* reliable protocol is used: */
 	(*nict)->timer_e_length = -1;	/* E is not ACTIVE */
 	(*nict)->timer_k_length = 0;	/* MUST do the transition immediatly */
 	(*nict)->timer_e_start.tv_sec = -1;
@@ -86,7 +87,7 @@
     (*nict)->port = 5060;
 
   (*nict)->timer_f_length = 64 * DEFAULT_T1;
-  gettimeofday (&(*nict)->timer_f_start, NULL);
+  osip_gettimeofday (&(*nict)->timer_f_start, NULL);
   add_gettimeofday (&(*nict)->timer_f_start, (*nict)->timer_f_length);
 
   /* Oups! a Bug! */
@@ -129,7 +130,7 @@
 __osip_nict_need_timer_e_event (osip_nict_t * nict, state_t state, int transactionid)
 {
   struct timeval now;
-  gettimeofday (&now, NULL);
+  osip_gettimeofday (&now, NULL);
 
   if (nict == NULL)
     return NULL;
@@ -137,7 +138,7 @@
     {
       if (nict->timer_e_start.tv_sec == -1)
 	return NULL;
-      if (timercmp (&now, &nict->timer_e_start, >))
+      if (osip_timercmp (&now, &nict->timer_e_start, >))
 	return __osip_event_new (TIMEOUT_E, transactionid);
     }
   return NULL;
@@ -148,7 +149,7 @@
 				int transactionid)
 {
   struct timeval now;
-  gettimeofday (&now, NULL);
+  osip_gettimeofday (&now, NULL);
 
   if (nict == NULL)
     return NULL;
@@ -156,7 +157,7 @@
     {
       if (nict->timer_f_start.tv_sec == -1)
 	return NULL;
-      if (timercmp (&now, &nict->timer_f_start, >))
+      if (osip_timercmp (&now, &nict->timer_f_start, >))
 	return __osip_event_new (TIMEOUT_F, transactionid);
     }
   return NULL;
@@ -167,7 +168,7 @@
 				int transactionid)
 {
   struct timeval now;
-  gettimeofday (&now, NULL);
+  osip_gettimeofday (&now, NULL);
 
   if (nict == NULL)
     return NULL;
@@ -175,7 +176,7 @@
     {
       if (nict->timer_k_start.tv_sec == -1)
 	return NULL;
-      if (timercmp (&now, &nict->timer_k_start, >))
+      if (osip_timercmp (&now, &nict->timer_k_start, >))
 	return __osip_event_new (TIMEOUT_K, transactionid);
     }
   return NULL;
--- libosip2-2.2.0/src/osip2/nict_fsm.c
+++ libosip2-2.2.1-alpha/src/osip2/nict_fsm.c
@@ -226,7 +226,7 @@
   else				/* in PROCEEDING STATE, TIMER is always 4000 */
     nict->nict_context->timer_e_length = 4000;
 
-  gettimeofday (&nict->nict_context->timer_e_start, NULL);
+  osip_gettimeofday (&nict->nict_context->timer_e_start, NULL);
   add_gettimeofday (&nict->nict_context->timer_e_start,
 		    nict->nict_context->timer_e_length);
 
@@ -306,7 +306,7 @@
 
   if (nict->state != NICT_COMPLETED)	/* reset timer K */
     {
-      gettimeofday (&nict->nict_context->timer_k_start, NULL);
+      osip_gettimeofday (&nict->nict_context->timer_k_start, NULL);
       add_gettimeofday (&nict->nict_context->timer_k_start,
 			nict->nict_context->timer_k_length);
     }
--- libosip2-2.2.0/src/osip2/nist.c
+++ libosip2-2.2.1-alpha/src/osip2/nist.c
@@ -48,14 +48,15 @@
     if (proto == NULL)
       goto ii_error_1;
 
-    i = osip_strncasecmp (proto, "TCP", 3);
-    if (i != 0)
+    if (osip_strcasecmp (proto, "TCP") != 0
+	&& osip_strcasecmp (proto, "TLS") !=0
+	&& osip_strcasecmp (proto, "SCTP") !=0)
       {
 	(*nist)->timer_j_length = 64 * DEFAULT_T1;
 	(*nist)->timer_j_start.tv_sec = -1;	/* not started */
       }
     else
-      {				/* TCP is used: */
+      {				/* reliable protocol is used: */
 	(*nist)->timer_j_length = 0;	/* MUST do the transition immediatly */
 	(*nist)->timer_j_start.tv_sec = -1;	/* not started */
       }
@@ -87,7 +88,7 @@
 __osip_nist_need_timer_j_event (osip_nist_t * nist, state_t state, int transactionid)
 {
   struct timeval now;
-  gettimeofday (&now, NULL);
+  osip_gettimeofday (&now, NULL);
 
   if (nist == NULL)
     return NULL;
@@ -95,7 +96,7 @@
     {
       if (nist->timer_j_start.tv_sec == -1)
 	return NULL;
-      if (timercmp (&now, &nist->timer_j_start, >))
+      if (osip_timercmp (&now, &nist->timer_j_start, >))
 	return __osip_event_new (TIMEOUT_J, transactionid);
     }
   return NULL;
--- libosip2-2.2.0/src/osip2/nist_fsm.c
+++ libosip2-2.2.1-alpha/src/osip2/nist_fsm.c
@@ -397,7 +397,7 @@
 
   if (nist->state != NIST_COMPLETED)	/* start J timer */
     {
-      gettimeofday (&nist->nist_context->timer_j_start, NULL);
+      osip_gettimeofday (&nist->nist_context->timer_j_start, NULL);
       add_gettimeofday (&nist->nist_context->timer_j_start,
 			nist->nist_context->timer_j_length);
     }
--- libosip2-2.2.0/src/osip2/osip.c
+++ libosip2-2.2.1-alpha/src/osip2/osip.c
@@ -786,8 +786,7 @@
 	}
       else
 	{
-	  if (0 == strcmp (evt->sip->cseq->method, "INVITE")
-	      || 0 == strcmp (evt->sip->cseq->method, "ACK"))
+	  if (0 == strcmp (evt->sip->cseq->method, "INVITE"))
 	    {
 	      transactions = osip->osip_ict_transactions;
 #ifdef OSIP_MT
@@ -807,8 +806,7 @@
     {
       if (MSG_IS_RESPONSE (evt->sip))
 	{
-	  if (0 == strcmp (evt->sip->cseq->method, "INVITE")
-	      || 0 == strcmp (evt->sip->cseq->method, "ACK"))
+	  if (0 == strcmp (evt->sip->cseq->method, "INVITE"))
 	    {
 	      transactions = osip->osip_ist_transactions;
 #ifdef OSIP_MT
@@ -1201,8 +1199,8 @@
   osip_transaction_t *tr;
   int pos = 0;
 
-  gettimeofday (&now, NULL);
-  lower_tv->tv_sec = now.tv_sec + 3600 * 24 * 265;	/* wake up evry year :-) */
+  osip_gettimeofday (&now, NULL);
+  lower_tv->tv_sec = now.tv_sec + 3600 * 24 * 365;	/* wake up evry year :-) */
   lower_tv->tv_usec = now.tv_usec;
 
 #ifdef OSIP_MT
@@ -1235,7 +1233,7 @@
 	    min_timercmp (lower_tv, &tr->ict_context->timer_a_start);
 	  if (tr->state == ICT_COMPLETED)
 	    min_timercmp (lower_tv, &tr->ict_context->timer_d_start);
-	  if (timercmp (&now, lower_tv, >))
+	  if (osip_timercmp (&now, lower_tv, >))
 	    {
 	      lower_tv->tv_sec = 0;
 	      lower_tv->tv_usec = 0;
@@ -1268,7 +1266,7 @@
 	min_timercmp (lower_tv, &tr->ist_context->timer_h_start);
       if (tr->state == IST_COMPLETED)
 	min_timercmp (lower_tv, &tr->ist_context->timer_g_start);
-      if (timercmp (&now, lower_tv, >))
+      if (osip_timercmp (&now, lower_tv, >))
 	{
 	  lower_tv->tv_sec = 0;
 	  lower_tv->tv_usec = 0;
@@ -1300,7 +1298,7 @@
 	min_timercmp (lower_tv, &tr->nict_context->timer_f_start);
       if (tr->state == NICT_PROCEEDING || tr->state == NICT_TRYING)
 	min_timercmp (lower_tv, &tr->nict_context->timer_e_start);
-      if (timercmp (&now, lower_tv, >))
+      if (osip_timercmp (&now, lower_tv, >))
 	{
 	  lower_tv->tv_sec = 0;
 	  lower_tv->tv_usec = 0;
@@ -1328,7 +1326,7 @@
 
       if (tr->state == NIST_COMPLETED)
 	min_timercmp (lower_tv, &tr->nist_context->timer_j_start);
-      if (timercmp (&now, lower_tv, >))
+      if (osip_timercmp (&now, lower_tv, >))
 	{
 	  lower_tv->tv_sec = 0;
 	  lower_tv->tv_usec = 0;
--- libosip2-2.2.0/src/osip2/osip_dialog.c
+++ libosip2-2.2.1-alpha/src/osip2/osip_dialog.c
@@ -27,6 +27,8 @@
 void
 osip_dialog_set_state (osip_dialog_t * dialog, state_t state)
 {
+  if (dialog == NULL)
+    return ;
   dialog->state = state;
 }
 
@@ -37,6 +39,11 @@
   osip_contact_t *contact;
   int i;
 
+  if (dialog == NULL)
+    return -1;
+  if (invite == NULL)
+    return -1;
+
   if (osip_list_eol (invite->contacts, 0))
     {
       OSIP_TRACE (osip_trace
@@ -62,6 +69,13 @@
 osip_dialog_update_osip_cseq_as_uas (osip_dialog_t * dialog,
 				     osip_message_t * invite)
 {
+  if (dialog == NULL)
+    return -1;
+  if (invite == NULL ||
+      invite->cseq == NULL ||
+      invite->cseq->number == NULL)
+    return -1;
+
   dialog->remote_cseq = osip_atoi (invite->cseq->number);
   return 0;
 }
@@ -74,6 +88,11 @@
   osip_contact_t *contact;
   int i;
 
+  if (dialog == NULL)
+    return -1;
+  if (response == NULL)
+    return -1;
+
   if (osip_list_eol (response->contacts, 0))
     {				/* no contact header in response? */
       OSIP_TRACE (osip_trace
@@ -128,8 +147,13 @@
   osip_generic_param_t *tag;
   int i;
 
+  if (dialog == NULL)
+    return -1;
+  if (response == NULL || response->to == NULL)
+    return -1;
+
   i = osip_to_get_tag (response->to, &tag);
-  if (i != 0)
+  if (i != 0 || tag==NULL || tag->gvalue==NULL)
     {
       OSIP_TRACE (osip_trace
 		  (__FILE__, __LINE__, OSIP_WARNING, NULL,
@@ -149,6 +173,11 @@
   char *tmp;
   int i;
 
+  if (dlg == NULL)
+    return -1;
+  if (answer == NULL || answer->call_id==NULL ||
+      answer->from==NULL || answer->to==NULL)
+    return -1;
 
   OSIP_TRACE (osip_trace
 	      (__FILE__, __LINE__, OSIP_WARNING, NULL,
@@ -228,6 +257,12 @@
   int i;
   char *tmp;
 
+  if (dlg == NULL)
+    return -1;
+  if (request == NULL || request->call_id==NULL ||
+      request->from==NULL || request->to==NULL)
+    return -1;
+
   osip_call_id_to_str (request->call_id, &tmp);
   if (0 != strcmp (dlg->call_id, tmp))
     {
@@ -293,6 +328,8 @@
   if (*dialog == NULL)
     return -1;
 
+  memset (*dialog, 0, sizeof (osip_dialog_t));
+
   (*dialog)->your_instance = NULL;
 
   (*dialog)->type = CALLER;
@@ -408,6 +445,7 @@
   if (*dialog == NULL)
     return -1;
 
+  memset (*dialog, 0, sizeof (osip_dialog_t));
   (*dialog)->your_instance = NULL;
 
   (*dialog)->type = CALLER;
@@ -504,6 +542,7 @@
   if (*dialog == NULL)
     return -1;
 
+  memset (*dialog, 0, sizeof (osip_dialog_t));
   (*dialog)->your_instance = NULL;
 
   (*dialog)->type = CALLEE;
--- libosip2-2.2.0/src/osip2/osip_negotiation.c
+++ libosip2-2.2.1-alpha/src/osip2/osip_negotiation.c
@@ -1024,18 +1024,10 @@
 				  osip_strdup (config->c_addr_multicast_ttl),
 				  osip_strdup (config->c_addr_multicast_int));
 
-  {				/* offer-answer draft says we must copy the "t=" line */
-    int now = time (NULL);
-    char *tmp = osip_malloc (15);
-    char *tmp2 = osip_malloc (15);
+  i = sdp_message_t_time_descr_add (*sdp, osip_strdup("0"), osip_strdup("0"));
+  if (i != 0)
+    return -1;
 
-    sprintf (tmp, "%i", now);
-    sprintf (tmp2, "%i", now + 3600);
-
-    i = sdp_message_t_time_descr_add (*sdp, tmp, tmp2);
-    if (i != 0)
-      return -1;
-  }
   if (config->fcn_set_attributes != NULL)
     config->fcn_set_attributes (con, *sdp, -1);
 
--- libosip2-2.2.0/src/osip2/osip_time.c
+++ libosip2-2.2.1-alpha/src/osip2/osip_time.c
@@ -18,9 +18,7 @@
 */
 
 #include <osip2/internal.h>
-#include <osip2/osip.h>
-
-#include "fsm.h"
+#include <osip2/osip_time.h>
 
 void
 add_gettimeofday (struct timeval *atv, int ms)
@@ -45,7 +43,7 @@
 {
   if (tv2->tv_sec == -1)
     return;
-  if (timercmp (tv1, tv2, >))
+  if (osip_timercmp (tv1, tv2, >))
     {
       /* replace tv1 with tv2 info */
       tv1->tv_sec = tv2->tv_sec;
@@ -53,13 +51,13 @@
     }
 }
 
-#ifdef WIN32
+#if defined(WIN32) || defined(_WIN32_WCE)
 
 #include <time.h>
 #include <sys/timeb.h>
 
 int
-gettimeofday (struct timeval *tp, void *tz)
+osip_gettimeofday (struct timeval *tp, void *tz)
 {
   struct _timeb timebuffer;
 
--- libosip2-2.2.0/src/osip2/port_condv.c
+++ libosip2-2.2.1-alpha/src/osip2/port_condv.c
@@ -19,9 +19,6 @@
 
 #ifdef OSIP_MT
 
-#ifndef __PORT_CONDV_H__
-#define __PORT_CONDV_H__
-
 #ifdef ENABLE_MPATROL
 #include <mpatrol.h>
 #endif
@@ -30,9 +27,14 @@
 #include <osip2/osip_mt.h>
 #include <osip2/osip_condv.h>
 
-#if !defined(__VXWORKS_OS__) && !defined(WIN32) && !defined(_WIN32_WCE) && !defined(__PSOS__)
-#if defined(HAVE_PTHREAD) || defined(HAVE_PTH_PTHREAD_H)
 
+#if !defined(__VXWORKS_OS__) && !defined(__PSOS__) && \
+	!defined(WIN32) && !defined(_WIN32_WCE) && !defined(HAVE_PTHREAD_WIN32) && \
+    !defined(HAVE_PTHREAD) && !defined(HAVE_PTH_PTHREAD_H)
+#error No thread implementation found!
+#endif
+
+#if defined(HAVE_PTHREAD) || defined(HAVE_PTH_PTHREAD_H) || defined(HAVE_PTHREAD_WIN32)
 /*
   #include <sys/types.h>
   #include <sys/timeb.h>
@@ -57,6 +59,7 @@
 {
   int ret;
 
+  if (!_cond) return -1;
   ret = pthread_cond_destroy (&_cond->cv);
   osip_free (_cond);
   return ret;
@@ -65,6 +68,7 @@
 int
 osip_cond_signal (struct osip_cond *_cond)
 {
+  if (!_cond) return -1;
   return pthread_cond_signal (&_cond->cv);
 }
 
@@ -72,6 +76,7 @@
 int
 osip_cond_wait (struct osip_cond *_cond, struct osip_mutex *_mut)
 {
+  if (!_cond) return -1;
   return pthread_cond_wait (&_cond->cv, (pthread_mutex_t *) _mut);
 }
 
@@ -80,22 +85,24 @@
 osip_cond_timedwait (struct osip_cond *_cond, struct osip_mutex *_mut,
 		     const struct timespec *abstime)
 {
+  if (!_cond) return -1;
   return pthread_cond_timedwait (&_cond->cv, (pthread_mutex_t *) _mut,
 				 (const struct timespec *) abstime);
 }
-#else
-#error NO thread implementation found
-#endif
+
 #endif
 
-#if defined (WIN32) || defined (_WIN32_WCE)
+
+#if (defined(WIN32) || defined(_WIN32_WCE)) && !defined(HAVE_PTHREAD_WIN32)
+
 #include <sys/types.h>
 #include <sys/timeb.h>
+
 struct osip_cond *
 osip_cond_init ()
 {
   osip_cond_t *cond = (osip_cond_t *) osip_malloc (sizeof (osip_cond_t));
-  if ((cond->mut = osip_mutex_init ()) != NULL)
+  if (cond && (cond->mut = osip_mutex_init ()) != NULL)
     {
       cond->sem = osip_sem_init (0);	/* initially locked */
       return (struct osip_cond *) (cond);
@@ -108,6 +115,7 @@
 int
 osip_cond_destroy (struct osip_cond *_cond)
 {
+  if (!_cond) return 0;
   if (_cond->sem == NULL)
     return 0;
 
@@ -124,6 +132,7 @@
 int
 osip_cond_signal (struct osip_cond *_cond)
 {
+  if (!_cond) return -1;
   return osip_sem_post (_cond->sem);
 }
 
@@ -133,6 +142,8 @@
 {
   int ret1 = 0, ret2 = 0, ret3 = 0;
 
+  if (!_cond) return -1;
+
   if (osip_mutex_lock (_cond->mut))
     return -1;
 
@@ -174,6 +185,8 @@
 {
   int difx;
 
+  if (start == NULL || end == NULL) return 0;
+
   difx = ((end->tv_sec - start->tv_sec) * 1000) +
     ((end->tv_nsec - start->tv_nsec) / 1000000);
 
@@ -188,7 +201,11 @@
   DWORD dwRet;
   struct timespec now;
   int timeout_ms;
-  HANDLE sem = *((HANDLE *) _cond->sem);
+  HANDLE sem;
+
+  if (!_cond) return -1;
+
+  sem = *((HANDLE *) _cond->sem);
 
   if (sem == NULL)
     return -1;
@@ -342,7 +359,6 @@
   return _cond_wait(_cond, _mut, ticks);
 }
 
-
-#endif
-#endif
 #endif
+
+#endif /* #ifdef OSIP_MT */
--- libosip2-2.2.0/src/osip2/port_sema.c
+++ libosip2-2.2.1-alpha/src/osip2/port_sema.c
@@ -27,8 +27,14 @@
 #include <osip2/internal.h>
 #include <osip2/osip_mt.h>
 
-#if !defined(__VXWORKS_OS__) && !defined(WIN32) && !defined(_WIN32_WCE) && !defined(__PSOS__)
-#if defined(HAVE_PTHREAD) || defined(HAVE_PTH_PTHREAD_H)
+
+#if !defined(__VXWORKS_OS__) && !defined(__PSOS__) && \
+	!defined(WIN32) && !defined(_WIN32_WCE) && !defined(HAVE_PTHREAD_WIN32) && \
+    !defined(HAVE_PTHREAD) && !defined(HAVE_PTH_PTHREAD_H)
+#error No thread implementation found!
+#endif
+
+#if defined(HAVE_PTHREAD) || defined(HAVE_PTH_PTHREAD_H) || defined(HAVE_PTHREAD_WIN32)
 
 struct osip_mutex *
 osip_mutex_init ()
@@ -69,17 +75,17 @@
   return pthread_mutex_unlock (mut);
 }
 
-#else
-#error NO thread implementation found
 #endif
 
-#if defined (HAVE_SEMAPHORE_H) && !defined(__APPLE_CC__)
+#if (defined(HAVE_SEMAPHORE_H) && !defined(__APPLE_CC__)) || defined(HAVE_PTHREAD_WIN32)
 
 /* Counting Semaphore is initialized to value */
 struct osip_sem *
 osip_sem_init (unsigned int value)
 {
   osip_sem_t *sem = (osip_sem_t *) osip_malloc (sizeof (osip_sem_t));
+  if (sem == NULL)
+    return NULL;
 
   if (sem_init (sem, 0, value) == 0)
     return (struct osip_sem *) sem;
@@ -137,6 +143,9 @@
   int i;
   osip_sem_t *sem = (osip_sem_t *) osip_malloc (sizeof (osip_sem_t));
 
+  if (sem == NULL)
+    return NULL;
+
   sem->semid = semget (IPC_PRIVATE, 1, IPC_CREAT | SEM_PERM);
   if (sem->semid == -1)
     {
@@ -209,11 +218,13 @@
   sb.sem_flg = IPC_NOWAIT;
   return semop (sem->semid, &sb, 1);
 }
+
 #endif
-#endif
+
 
 /* use VxWorks implementation */
 #ifdef __VXWORKS_OS__
+
 struct osip_mutex *
 osip_mutex_init ()
 {
@@ -300,16 +311,20 @@
     return -1;
   return semTake (sem->semId, NO_WAIT);
 }
+
 #endif
 
-#if defined (WIN32) || defined (_WIN32_WCE)
+
+#if (defined(WIN32) || defined(_WIN32_WCE)) && !defined(HAVE_PTHREAD_WIN32)
 
 #include <limits.h>
+
 struct osip_mutex *
 osip_mutex_init ()
 {
   osip_mutex_t *mut = (osip_mutex_t *) osip_malloc (sizeof (osip_mutex_t));
-
+  if (mut == NULL)
+    return NULL;
   if ((mut->h = CreateMutex (NULL, FALSE, NULL)) != NULL)
     return (struct osip_mutex *) (mut);
   osip_free (mut);
@@ -353,6 +368,8 @@
 osip_sem_init (unsigned int value)
 {
   osip_sem_t *sem = (osip_sem_t *) osip_malloc (sizeof (osip_sem_t));
+  if (sem == NULL)
+    return NULL;
 
   if ((sem->h = CreateSemaphore (NULL, value, LONG_MAX, NULL)) != NULL)
     return (struct osip_sem *) (sem);
@@ -509,6 +526,7 @@
     return (-1);
   return (0);
 }
-#endif
 
 #endif
+
+#endif /* #ifdef OSIP_MT */
--- libosip2-2.2.0/src/osip2/port_thread.c
+++ libosip2-2.2.1-alpha/src/osip2/port_thread.c
@@ -24,18 +24,21 @@
 #include <osip2/internal.h>
 #include <osip2/osip_mt.h>
 
-#if defined _WIN32_WCE
-#include <winbase.h>
-#define _beginthreadex	CreateThread
-#define	_endthreadex	ExitThread
-#elif defined WIN32
-#include <process.h>
+#if (defined(WIN32) || defined(_WIN32_WCE)) && !defined(HAVE_PTHREAD_WIN32)
+#  if defined _WIN32_WCE
+#    include <winbase.h>
+#    define _beginthreadex	CreateThread
+#    define	_endthreadex	ExitThread
+#  elif defined WIN32
+#    include <process.h>
+#  endif
 #endif
 
 /* stack size is only needed on VxWorks. */
 
 #ifndef __VXWORKS_OS__
-#if defined(HAVE_PTHREAD) || defined(HAVE_PTH_PTHREAD_H)
+#if defined(HAVE_PTHREAD) || defined(HAVE_PTH_PTHREAD_H) || defined(HAVE_PTHREAD_WIN32)
+
 struct osip_thread *
 osip_thread_create (int stacksize, void *(*func) (void *), void *arg)
 {
@@ -80,7 +83,9 @@
 #endif
 #endif
 
-#ifdef WIN32
+
+#if (defined(WIN32) || defined(_WIN32_WCE)) && !defined(HAVE_PTHREAD_WIN32)
+
 struct osip_thread *
 osip_thread_create (int stacksize, void *(*func) (void *), void *arg)
 {
@@ -231,6 +236,7 @@
 {
   /*?? */
 }
-#endif
 
 #endif
+
+#endif /* #ifdef OSIP_MT */
--- libosip2-2.2.0/src/osipparser2/osip_body.c
+++ libosip2-2.2.1-alpha/src/osipparser2/osip_body.c
@@ -92,9 +92,10 @@
     return -1;
 
   
-  copy->body = (char*)osip_malloc(body->length+1);
+  copy->body = (char*)osip_malloc(body->length+2);
   copy->length = body->length;
   memcpy(copy->body,body->body,body->length);
+  copy->body[body->length]='\0';
 
   if (body->content_type != NULL)
     {
--- libosip2-2.2.0/src/osipparser2/osip_list.c
+++ libosip2-2.2.1-alpha/src/osipparser2/osip_list.c
@@ -26,7 +26,9 @@
 int
 osip_list_init (osip_list_t * li)
 {
-  li->nb_elt = 0;
+  if (li==NULL)
+    return -1;
+  memset(li, 0, sizeof(osip_list_t));
   return 0;			/* ok */
 }
 
@@ -42,7 +44,8 @@
     {
       element = (void *) osip_list_get (li, pos);
       osip_list_remove (li, pos);
-      free_func (element);
+      if (free_func!=NULL)
+	free_func (element);
     }
   osip_free (li);
 }
@@ -96,6 +99,8 @@
   __node_t *ntmp;
   int i = 0;
 
+  if (li == NULL) return -1;
+
   if (pos == -1 || pos >= li->nb_elt)
     {				/* insert at the end  */
       pos = li->nb_elt;
@@ -105,22 +110,30 @@
     {
 
       li->node = (__node_t *) osip_malloc (sizeof (__node_t));
+      if (li->node == NULL) return -1;
       li->node->element = el;
+      li->node->next = NULL;
       li->nb_elt++;
       return li->nb_elt;
     }
 
   ntmp = li->node;		/* exist because nb_elt>0  */
 
-  if (pos == 0)
+  if (pos == 0) /* pos = 0 insert before first elt  */
     {
       li->node = (__node_t *) osip_malloc (sizeof (__node_t));
+      if (li->node == NULL)
+	{
+	  /* leave the list unchanged */
+	  li->node=ntmp;
+	  return -1;
+	}
       li->node->element = el;
       li->node->next = ntmp;
       li->nb_elt++;
       return li->nb_elt;
     }
-  /* pos = 0 insert before first elt  */
+  
 
   while (pos > i + 1)
     {
@@ -133,8 +146,10 @@
   if (pos == li->nb_elt)
     {
       ntmp->next = (__node_t *) osip_malloc (sizeof (__node_t));
+      if (li->node == NULL) return -1; /* leave the list unchanged */
       ntmp = (__node_t *) ntmp->next;
       ntmp->element = el;
+      ntmp->next = NULL;
       li->nb_elt++;
       return li->nb_elt;
     }
@@ -144,6 +159,11 @@
     __node_t *nextnode = (__node_t *) ntmp->next;
 
     ntmp->next = (__node_t *) osip_malloc (sizeof (__node_t));
+    if (ntmp->next ==  NULL) {
+      /* leave the list unchanged */
+      ntmp->next=nextnode;
+      return -1;
+    }
     ntmp = (__node_t *) ntmp->next;
     ntmp->element = el;
     ntmp->next = nextnode;
@@ -159,9 +179,11 @@
   __node_t *ntmp;
   int i = 0;
 
+  if (li == NULL) return NULL;
+
   if (pos < 0 || pos >= li->nb_elt)
     /* element does not exist */
-    return 0;
+    return NULL;
 
 
   ntmp = li->node;		/* exist because nb_elt>0 */
@@ -182,6 +204,8 @@
   __node_t *ntmp;
   int i = 0;
 
+  if (li == NULL) return -1;
+
   if (pos < 0 || pos >= li->nb_elt)
     /* element does not exist */
     return -1;
--- libosip2-2.2.0/src/osipparser2/osip_message.c
+++ libosip2-2.2.1-alpha/src/osipparser2/osip_message.c
@@ -25,9 +25,6 @@
 #include <osipparser2/osip_message.h>
 
 /* enable logging of memory accesses */
-#ifdef MEMORY_LEAKS
-static int freesipcptr = 0;
-#endif
 
 const char *osip_protocol_version = "SIP/2.0";
 
@@ -35,25 +32,10 @@
 int
 osip_message_init (osip_message_t ** sip)
 {
-#ifdef MEMORY_LEAKS
-  static int comptr = 0;
-
-  comptr++;
-  freesipcptr++;
-#endif
   *sip = (osip_message_t *) osip_malloc (sizeof (osip_message_t));
-#ifdef MEMORY_LEAKS
-  osip_trace (__FILE__, __LINE__, TRACE_LEVEL0, NULL,
-	      "<msg_write.c> osip_message_init() = %i, malloc-free = %i, address = %x\n",
-	      comptr, freesipcptr, *sip);
-  fflush (stdout);
-#endif
-
-  (*sip)->sip_method = NULL;
-  (*sip)->sip_version = NULL;
-  (*sip)->status_code = 0;
-  (*sip)->reason_phrase = NULL;
-  (*sip)->req_uri = NULL;
+  if (*sip==NULL)
+    return -1;
+  memset(*sip, 0, sizeof(osip_message_t));
 
   (*sip)->accepts = (osip_list_t *) osip_malloc (sizeof (osip_list_t));
   osip_list_init ((*sip)->accepts);
@@ -161,17 +143,6 @@
 {
   int pos = 0;
 
-#ifdef MEMORY_LEAKS
-  static int comptr = 0;
-
-  if (sip == NULL)
-    return;
-  comptr--;
-  freesipcptr--;
-  osip_trace (__FILE__, __LINE__, TRACE_LEVEL0, NULL,
-	      "<msg_write.c> osip_message_free() = %i, malloc-free = %i, address = %x\n",
-	      comptr, freesipcptr, sip);
-#endif
   if (sip == NULL)
     return;
 
--- libosip2-2.2.0/src/osipparser2/osip_message_parse.c
+++ libosip2-2.2.1-alpha/src/osipparser2/osip_message_parse.c
@@ -220,16 +220,34 @@
 
 int
 __osip_find_next_occurence (const char *str, const char *buf,
-			    const char **index_of_str)
+			    const char **index_of_str, const char *end_of_buf)
 {
+  int i;
   *index_of_str = NULL;		/* AMD fix */
   if ((NULL == str) || (NULL == buf))
     return -1;
   /* TODO? we may prefer strcasestr instead of strstr? */
-  *index_of_str = strstr (buf, str);
-  if (NULL == (*index_of_str))
-    return -1;
-  return 0;
+  for (i=0;i<1000;i++)
+    {
+      *index_of_str = strstr (buf, str);
+      if (NULL == (*index_of_str))
+	{
+	  /* if '\0' (when binary data is used) is located before the separator,
+	     then we have to continue searching */
+	  const char *ptr = buf + strlen(buf);
+	  if (end_of_buf-ptr>0)
+	    {
+	      buf = ptr+1;
+	      continue;
+	    }
+	  return -1;
+	}
+      return 0;
+    }
+  OSIP_TRACE (osip_trace
+	      (__FILE__, __LINE__, OSIP_BUG, NULL,
+	       "This was probably an infinite loop?\n"));
+  return -1;
 }
 
 /* This method replace all LWS with SP located before the
@@ -650,6 +668,7 @@
 {
   const char *start_of_body;
   const char *end_of_body;
+  const char *end_of_buf;
   char *tmp;
   int i;
 
@@ -744,11 +763,14 @@
 
   *next_body = NULL;
   start_of_body = start_of_buf;
+
+  end_of_buf = start_of_buf+length;
+
   for (;;)
     {
       i =
 	__osip_find_next_occurence (sep_boundary, start_of_body,
-				    &start_of_body);
+				    &start_of_body, end_of_buf);
       if (i == -1)
 	{
 	  osip_free (sep_boundary);
@@ -757,7 +779,7 @@
       i =
 	__osip_find_next_occurence (sep_boundary,
 				    start_of_body + strlen (sep_boundary),
-				    &end_of_body);
+				    &end_of_body, end_of_buf);
       if (i == -1)
 	{
 	  osip_free (sep_boundary);
--- libosip2-2.2.0/src/osipparser2/osip_message_to_str.c
+++ libosip2-2.2.1-alpha/src/osipparser2/osip_message_to_str.c
@@ -910,7 +910,7 @@
 	{
 	  size_t size = message - *dest;
 	  int offset_of_body;
-	  int offset_content_length_to_modify;
+	  int offset_content_length_to_modify = 0;
 	  offset_of_body = start_of_bodies - *dest;
 	  if (content_length_to_modify != NULL)
 	    offset_content_length_to_modify = content_length_to_modify - *dest;
--- libosip2-2.2.0/src/osipparser2/osip_port.c
+++ libosip2-2.2.1-alpha/src/osipparser2/osip_port.c
@@ -46,6 +46,12 @@
 
 #if defined(__VXWORKS_OS__)
 #include <selectLib.h>
+
+/* needed for snprintf replacement */
+#include <vxWorks.h>
+#include <fioLib.h>
+#include <string.h>
+
 #elif (!defined(WIN32) && !defined(_WIN32_WCE))
 #include <sys/time.h>
 #elif defined(WIN32)
@@ -106,6 +112,10 @@
       ticks = lCount.LowPart + lCount.HighPart;
 #elif defined(_WIN32_WCE)
       ticks = GetTickCount();
+#elif defined(__VXWORKS_OS__)
+      struct timespec tp;
+      clock_gettime(CLOCK_REALTIME, &tp);
+      ticks = tp.tv_sec+tp.tv_nsec;
 #else
       struct timeval tv;
       int fd;
@@ -189,11 +199,7 @@
 char *
 osip_strncpy (char *dest, const char *src, size_t length)
 {
-#ifdef WIN32
   strncpy (dest, src, length);
-#else
-  strncpy (dest, src, length);
-#endif
   dest[length] = '\0';
   return dest;
 }
@@ -296,7 +302,14 @@
 int
 osip_strcasecmp (const char *s1, const char *s2)
 {
-#if (!defined WIN32 && !defined _WIN32_WCE)
+#if defined(__VXWORKS_OS__)
+  while ( (*s1 != '\0') && (tolower(*s1) == tolower(*s2)) )
+  {
+    s1++;
+    s2++;
+  }
+  return (tolower(*s1) - tolower(*s2));
+#elif (!defined WIN32 && !defined _WIN32_WCE)
   return strcasecmp (s1, s2);
 #else
   return _stricmp (s1, s2);
@@ -306,7 +319,18 @@
 int
 osip_strncasecmp (const char *s1, const char *s2, size_t len)
 {
-#if (!defined WIN32 && !defined _WIN32_WCE)
+#if defined(__VXWORKS_OS__)
+  if ( len == 0 ) return 0;
+  while ( (len > 0) && (tolower(*s1) == tolower(*s2)) )
+  {
+    len--;
+    if ( (len == 0) || (*s1 == '\0') || (*s2 == '\0') )
+            break;
+    s1++;
+    s2++;
+  }
+  return tolower(*s1) - tolower(*s2);
+#elif (!defined WIN32 && !defined _WIN32_WCE)
   return strncasecmp (s1, s2, len);
 #else
   return _strnicmp (s1, s2, len);
@@ -684,8 +708,8 @@
 osip_trace (char *fi, int li, osip_trace_level_t level, FILE * f, char *chfr,
 	    ...)
 {
-  va_list ap;
 #ifdef ENABLE_TRACE
+  va_list ap;
 
 #if !defined(WIN32) && !defined(SYSTEM_LOGGER_ENABLED)
   if (logfile == NULL && use_syslog == 0 && trace_func == NULL)
@@ -848,3 +872,61 @@
 
 #endif
 
+#if defined(__VXWORKS_OS__)
+
+typedef struct
+{
+  char* str;
+  int   max;
+  int   len;
+} _context;
+
+STATUS _cb_snprintf( char* buffer, int nc, int arg );
+
+STATUS _cb_snprintf( char* buffer, int nc, int arg )
+{
+  _context *ctx = (_context*)arg;
+  
+  if( ctx->max - ctx->len - nc < 1 ) /* retain 1 pos for terminating \0 */
+  {
+    nc = ctx->max - ctx->len - 1;
+  }
+ 
+  if( nc > 0 )
+  {
+    memcpy( ctx->str + ctx->len, buffer, nc );
+    ctx->len += nc;
+  }
+
+  ctx->str[ctx->len] = '\0';
+
+  return OK;
+}
+
+
+int osip_vsnprintf( char* buf, int max, const char *fmt, va_list ap )
+{
+  _context ctx;  
+  ctx.str = buf;
+  ctx.max = max;
+  ctx.len = 0;
+
+  if( fioFormatV( fmt, ap, _cb_snprintf, (int)&ctx ) != OK )
+  {
+    return -1;
+  }
+
+  return ctx.len;
+}
+
+int osip_snprintf( char* buf, int max, const char* fmt, ... )
+{
+  int retval;
+  va_list ap;
+  va_start( ap, fmt );
+  retval = osip_vsnprintf( buf, max, fmt, ap );
+  va_end( ap );
+  return retval;
+}
+
+#endif
--- libosip2-2.2.0/src/osipparser2/osip_via.c
+++ libosip2-2.2.1-alpha/src/osipparser2/osip_via.c
@@ -101,11 +101,8 @@
   *via = (osip_via_t *) osip_malloc (sizeof (osip_via_t));
   if (*via == NULL)
     return -1;
-  (*via)->version = NULL;
-  (*via)->protocol = NULL;
-  (*via)->host = NULL;
-  (*via)->port = NULL;
-  (*via)->comment = NULL;
+
+  memset(*via, 0, sizeof(osip_via_t));
 
   (*via)->via_params = (osip_list_t *) osip_malloc (sizeof (osip_list_t));
   if ((*via)->via_params == NULL)
--- libosip2-2.2.0/src/osipparser2/parser.h
+++ libosip2-2.2.1-alpha/src/osipparser2/parser.h
@@ -38,7 +38,7 @@
 int __osip_message_is_known_header (const char *hname);
 
 int __osip_find_next_occurence (const char *str, const char *buf,
-				const char **index_of_str);
+				const char **index_of_str, const char *end_of_buf);
 int __osip_find_next_crlf (const char *start_of_header,
 			   const char **end_of_header);
 int __osip_find_next_crlfcrlf (const char *start_of_part,
--- libosip2-2.2.0/src/osipparser2/sdp_message.c
+++ libosip2-2.2.1-alpha/src/osipparser2/sdp_message.c
@@ -348,10 +348,25 @@
   /* o=username sess-id sess-version nettype addrtype addr */
 
   /* useranme can contain any char (ascii) except "space" and CRLF */
+#ifdef FIREFLY_BUG_SUPPORT
+  if (tmp[0]==' ')
+    {
+      sdp->o_username = strdup("firefly");
+      tmp++;
+    }
+  else
+    {
+      i = __osip_set_next_token (&(sdp->o_username), tmp, ' ', &tmp_next);
+      if (i != 0)
+	return -1;
+      tmp = tmp_next;
+    }
+#else
   i = __osip_set_next_token (&(sdp->o_username), tmp, ' ', &tmp_next);
   if (i != 0)
     return -1;
   tmp = tmp_next;
+#endif
 
   /* sess_id contains only numeric characters */
   i = __osip_set_next_token (&(sdp->o_sess_id), tmp, ' ', &tmp_next);
@@ -417,8 +432,20 @@
     crlf++;
   if (*crlf == '\0')
     return ERR_ERROR;
+#ifdef FIREFLY_BUG_SUPPORT
+  if (crlf == equal + 1)
+    {
+      sdp->s_name = strdup(" ");
+      if (crlf[1] == '\n')
+	*next = crlf + 2;
+      else
+	*next = crlf + 1;
+      return WF;		/* o=\r ?? bad header */
+    }
+#else
   if (crlf == equal + 1)
     return ERR_ERROR;		/* o=\r ?? bad header */
+#endif
 
   /* s=text */
 
